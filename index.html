<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Daydate Admin Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <style>
    :root {
      --bg: #0f0f0f;
      --surface: #1a1a1a;
      --surface2: #242424;
      --border: #333;
      --text: #e8e8e8;
      --text-sub: #888;
      --accent: #7c5cfc;
      --accent-hover: #6a4aec;
      --green: #34d399;
      --red: #f87171;
      --orange: #fbbf24;
      --blue: #60a5fa;
      --radius: 10px;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    /* â”€â”€â”€ Login â”€â”€â”€ */
    .login-wrap {
      display: flex; align-items: center; justify-content: center;
      min-height: 100vh; padding: 20px;
    }
    .login-box {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: var(--radius); padding: 40px; width: 100%; max-width: 400px;
    }
    .login-box h1 { font-size: 24px; margin-bottom: 8px; }
    .login-box p { color: var(--text-sub); margin-bottom: 24px; font-size: 14px; }
    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; font-size: 13px; color: var(--text-sub); margin-bottom: 6px; }
    .form-group input, .form-group textarea, .form-group select {
      width: 100%; padding: 10px 12px; background: var(--surface2);
      border: 1px solid var(--border); border-radius: 8px;
      color: var(--text); font-size: 14px; outline: none;
    }
    .form-group input:focus, .form-group textarea:focus {
      border-color: var(--accent);
    }
    .btn {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 10px 18px; border: none; border-radius: 8px;
      font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.15s;
    }
    .btn-primary { background: var(--accent); color: #fff; }
    .btn-primary:hover { background: var(--accent-hover); }
    .btn-green { background: var(--green); color: #000; }
    .btn-red { background: var(--red); color: #000; }
    .btn-orange { background: var(--orange); color: #000; }
    .btn-outline {
      background: transparent; border: 1px solid var(--border); color: var(--text);
    }
    .btn-outline:hover { border-color: var(--text-sub); }
    .btn-sm { padding: 6px 12px; font-size: 12px; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-full { width: 100%; justify-content: center; }
    .error-msg { color: var(--red); font-size: 13px; margin-top: 8px; }

    /* â”€â”€â”€ Layout â”€â”€â”€ */
    .app { display: none; }
    .header {
      background: var(--surface); border-bottom: 1px solid var(--border);
      padding: 16px 24px; display: flex; align-items: center; justify-content: space-between;
      position: sticky; top: 0; z-index: 100;
    }
    .header h1 { font-size: 18px; }
    .header-right { display: flex; align-items: center; gap: 12px; }
    .user-email { font-size: 13px; color: var(--text-sub); }

    .container { max-width: 1200px; margin: 0 auto; padding: 24px; }

    /* â”€â”€â”€ Main Navigation â”€â”€â”€ */
    .main-nav {
      display: flex; gap: 0; background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 0 24px; position: sticky; top: 54px; z-index: 99;
    }
    .main-nav-item {
      padding: 14px 24px; cursor: pointer; font-size: 14px; font-weight: 500;
      color: var(--text-sub); border-bottom: 2px solid transparent;
      transition: all 0.15s; white-space: nowrap;
    }
    .main-nav-item:hover { color: var(--text); }
    .main-nav-item.active {
      color: var(--accent); border-bottom-color: var(--accent);
    }
    .main-section { display: none; }
    .main-section.active { display: block; }

    /* â”€â”€â”€ Sub Tabs â”€â”€â”€ */
    .tabs { display: flex; gap: 4px; margin-bottom: 20px; }
    .tab {
      padding: 10px 20px; border-radius: 8px; cursor: pointer;
      font-size: 14px; background: transparent; border: 1px solid var(--border);
      color: var(--text-sub); transition: all 0.15s;
    }
    .tab.active { background: var(--accent); border-color: var(--accent); color: #fff; }

    /* â”€â”€â”€ Toolbar â”€â”€â”€ */
    .toolbar {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 16px; flex-wrap: wrap; gap: 12px;
    }
    .toolbar-left { display: flex; gap: 8px; align-items: center; }
    .toolbar-right { display: flex; gap: 8px; }
    .count-badge {
      font-size: 13px; color: var(--text-sub);
      padding: 6px 12px; background: var(--surface2); border-radius: 20px;
    }

    /* â”€â”€â”€ Cards â”€â”€â”€ */
    .post-grid {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
      gap: 16px;
    }
    .post-card {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: var(--radius); overflow: hidden; transition: border-color 0.15s;
    }
    .post-card:hover { border-color: var(--text-sub); }
    .post-card-img {
      width: 100%; height: 180px; object-fit: cover; background: var(--surface2);
    }
    .post-card-body { padding: 16px; }
    .post-card-title {
      font-size: 15px; font-weight: 600; margin-bottom: 6px;
      overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }
    .post-card-caption {
      font-size: 13px; color: var(--text-sub); margin-bottom: 10px;
      display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
      overflow: hidden; line-height: 1.5;
    }
    .post-card-meta {
      display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px;
    }
    .badge {
      font-size: 11px; padding: 3px 8px; border-radius: 4px;
      background: var(--surface2); color: var(--text-sub);
    }
    .badge-published { background: rgba(52,211,153,0.15); color: var(--green); }
    .badge-draft { background: rgba(251,191,36,0.15); color: var(--orange); }
    .badge-cat { background: rgba(124,92,252,0.15); color: var(--accent); }
    .badge-country { background: rgba(59, 130, 246, 0.15); color: #60a5fa; }
    .post-card-actions { display: flex; gap: 6px; flex-wrap: wrap; }
    .post-card-checkbox {
      position: absolute; top: 12px; left: 12px; width: 20px; height: 20px;
      accent-color: var(--accent);
    }
    .post-card-img-wrap { position: relative; }
    .no-img {
      width: 100%; height: 180px; display: flex; align-items: center;
      justify-content: center; background: var(--surface2); color: var(--text-sub);
      font-size: 13px;
    }

    /* â”€â”€â”€ Modal â”€â”€â”€ */
    .modal-overlay {
      display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7);
      z-index: 200; align-items: center; justify-content: center; padding: 20px;
    }
    .modal-overlay.show { display: flex; }
    .modal {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: var(--radius); max-width: 640px; width: 100%;
      max-height: 85vh; overflow-y: auto; padding: 28px;
    }
    .modal h2 { font-size: 18px; margin-bottom: 20px; }
    .modal-footer { display: flex; gap: 8px; justify-content: flex-end; margin-top: 24px; }

    /* â”€â”€â”€ Action Panel â”€â”€â”€ */
    .action-panel {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: var(--radius); padding: 20px; margin-bottom: 24px;
      position: relative;
    }
    .action-panel h3 { font-size: 15px; margin-bottom: 14px; }
    .action-row { display: flex; gap: 12px; align-items: flex-end; flex-wrap: wrap; }
    .action-row .form-group { flex: 1; min-width: 200px; margin-bottom: 0; }
    .action-panel.collapsed .action-panel-body { display: none; }
    .action-panel-header {
      display: flex; align-items: center; justify-content: space-between;
      cursor: pointer; user-select: none;
    }
    .action-panel-header h3 { margin-bottom: 0; }
    .collapse-icon {
      font-size: 18px; color: var(--text-sub); transition: transform 0.2s;
    }
    .action-panel.collapsed .collapse-icon { transform: rotate(-90deg); }

    /* â”€â”€â”€ Curation Form â”€â”€â”€ */
    .curate-section { margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--border); }
    .curate-section:last-of-type { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
    .section-label {
      display: block; font-size: 11px; font-weight: 600; text-transform: uppercase;
      letter-spacing: 0.5px; color: var(--accent); margin-bottom: 12px;
    }
    .curate-row { display: flex; gap: 12px; margin-bottom: 12px; }
    .curate-row:last-child { margin-bottom: 0; }
    .curate-row .form-group { margin-bottom: 0; }
    .image-upload-zone {
      border: 2px dashed var(--border); border-radius: var(--radius);
      padding: 16px; transition: border-color 0.2s; min-height: 100px;
    }
    .image-upload-zone.dragover { border-color: var(--accent); background: rgba(124, 92, 252, 0.05); }
    .upload-placeholder {
      display: flex; flex-direction: column; align-items: center; gap: 4px;
      cursor: pointer; padding: 16px; color: var(--text-sub); font-size: 13px;
    }
    .upload-placeholder .upload-icon { font-size: 24px; }
    .upload-placeholder .upload-hint { font-size: 11px; opacity: 0.6; }
    .image-preview-grid { display: flex; gap: 8px; flex-wrap: wrap; }
    .image-preview-grid .preview-item {
      position: relative; width: 72px; height: 72px; border-radius: 8px; overflow: hidden;
    }
    .image-preview-grid .preview-item img { width: 100%; height: 100%; object-fit: cover; }
    .image-preview-grid .preview-item .remove-btn {
      position: absolute; top: 2px; right: 2px; background: rgba(0,0,0,0.6); color: #fff;
      border: none; border-radius: 50%; width: 18px; height: 18px; font-size: 10px;
      cursor: pointer; display: flex; align-items: center; justify-content: center;
    }

    /* â”€â”€â”€ Country Filter â”€â”€â”€ */
    .country-filter { display: flex; gap: 4px; margin-bottom: 16px; flex-wrap: wrap; }
    .country-btn {
      padding: 6px 14px; border-radius: 6px; cursor: pointer; font-size: 13px;
      background: transparent; border: 1px solid var(--border); color: var(--text-sub); transition: all 0.15s;
    }
    .country-btn.active { background: rgba(59, 130, 246, 0.15); border-color: #3b82f6; color: #60a5fa; }
    .country-btn:hover { border-color: var(--text-sub); }

    /* â”€â”€â”€ Stat Cards â”€â”€â”€ */
    .stat-grid {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 16px; margin-bottom: 24px;
    }
    .stat-card {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: var(--radius); padding: 20px;
    }
    .stat-card-label { font-size: 12px; color: var(--text-sub); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
    .stat-card-value { font-size: 28px; font-weight: 700; }
    .stat-card-sub { font-size: 12px; color: var(--text-sub); margin-top: 4px; }

    /* â”€â”€â”€ Country Cards â”€â”€â”€ */
    .country-grid {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 16px; margin-bottom: 24px;
    }
    .country-card {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: var(--radius); padding: 20px; cursor: pointer;
      transition: border-color 0.15s;
    }
    .country-card:hover { border-color: var(--accent); }
    .country-card-header {
      display: flex; align-items: center; gap: 10px; margin-bottom: 14px;
    }
    .country-card-flag { font-size: 32px; }
    .country-card-name { font-size: 16px; font-weight: 600; }
    .country-card-code { font-size: 12px; color: var(--text-sub); }
    .country-card-stats { display: flex; flex-direction: column; gap: 6px; margin-bottom: 14px; }
    .country-card-stat {
      display: flex; justify-content: space-between; font-size: 13px;
    }
    .country-card-stat-label { color: var(--text-sub); }
    .country-card-categories { display: flex; gap: 6px; flex-wrap: wrap; }

    /* â”€â”€â”€ API Cards â”€â”€â”€ */
    .api-grid {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 16px; margin-bottom: 24px;
    }
    .api-card {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: var(--radius); padding: 20px;
    }
    .api-card-header {
      display: flex; align-items: center; gap: 10px; margin-bottom: 14px;
    }
    .api-card-icon { font-size: 24px; }
    .api-card-name { font-size: 16px; font-weight: 600; }
    .api-card-status {
      font-size: 11px; padding: 3px 8px; border-radius: 4px;
      background: rgba(52,211,153,0.15); color: var(--green);
    }

    /* â”€â”€â”€ Top Management â”€â”€â”€ */
    .top-rank-item {
      display: flex; align-items: center; gap: 12px;
      padding: 10px 14px; background: var(--surface2); border-radius: 8px;
      border: 1px solid var(--border);
    }
    .top-rank-badge {
      min-width: 48px; text-align: center; font-size: 13px; font-weight: 700;
      padding: 4px 10px; border-radius: 6px;
      background: rgba(255,75,110,0.2); color: #FF4B6E;
    }
    .top-rank-title {
      flex: 1; font-size: 14px; font-weight: 500;
      overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }
    .top-rank-category { font-size: 11px; color: var(--accent); }
    .top-rank-priority {
      font-size: 12px; color: var(--text-sub);
      display: flex; align-items: center; gap: 6px;
    }
    .top-rank-priority input {
      width: 60px; padding: 4px 8px; background: var(--bg);
      border: 1px solid var(--border); border-radius: 4px;
      color: var(--text); font-size: 13px; text-align: center;
    }
    .top-empty { color: var(--text-sub); font-size: 13px; font-style: italic; padding: 8px 0; }

    /* â”€â”€â”€ Cron Table â”€â”€â”€ */
    .data-table {
      width: 100%; border-collapse: collapse; font-size: 13px;
      background: var(--surface); border: 1px solid var(--border);
      border-radius: var(--radius); overflow: hidden;
    }
    .data-table th {
      text-align: left; padding: 12px 16px; background: var(--surface2);
      color: var(--text-sub); font-weight: 600; font-size: 11px;
      text-transform: uppercase; letter-spacing: 0.5px;
    }
    .data-table td {
      padding: 10px 16px; border-top: 1px solid var(--border);
    }
    .data-table tr:hover td { background: rgba(124,92,252,0.03); }

    /* â”€â”€â”€ Back Button â”€â”€â”€ */
    .back-btn {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 8px 16px; border: 1px solid var(--border); border-radius: 8px;
      background: transparent; color: var(--text); font-size: 14px;
      cursor: pointer; margin-bottom: 16px; transition: all 0.15s;
    }
    .back-btn:hover { border-color: var(--text-sub); }

    /* â”€â”€â”€ Toast â”€â”€â”€ */
    .toast-container {
      position: fixed; top: 20px; right: 20px; z-index: 999;
      display: flex; flex-direction: column; gap: 8px;
    }
    .toast {
      padding: 12px 20px; border-radius: 8px; font-size: 14px;
      animation: slideIn 0.2s ease; min-width: 250px;
    }
    .toast-success { background: var(--green); color: #000; }
    .toast-error { background: var(--red); color: #000; }
    .toast-info { background: var(--accent); color: #fff; }
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    /* â”€â”€â”€ Spinner â”€â”€â”€ */
    .spinner {
      display: inline-block; width: 16px; height: 16px;
      border: 2px solid rgba(255,255,255,0.3); border-top-color: #fff;
      border-radius: 50%; animation: spin 0.6s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.5);
      display: flex; align-items: center; justify-content: center;
      z-index: 300; display: none;
    }
    .loading-overlay.show { display: flex; }
    .loading-box {
      background: var(--surface); padding: 24px 32px; border-radius: var(--radius);
      display: flex; align-items: center; gap: 12px; font-size: 14px;
    }

    /* â”€â”€â”€ Sync Cache Table â”€â”€â”€ */
    .cache-grid {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 12px; margin-top: 16px;
    }
    .cache-entry {
      background: var(--surface2); border-radius: 8px; padding: 12px;
      font-size: 12px;
    }
    .cache-entry-country { font-weight: 600; font-size: 14px; margin-bottom: 4px; }
    .cache-entry-detail { color: var(--text-sub); }

    /* â”€â”€â”€ Feed Source Sub-tabs â”€â”€â”€ */
    .source-tabs { display: flex; gap: 4px; margin-bottom: 16px; }
    .source-tab {
      padding: 8px 16px; border-radius: 8px; cursor: pointer;
      font-size: 13px; background: transparent; border: 1px solid var(--border);
      color: var(--text-sub); transition: all 0.15s; font-weight: 500;
    }
    .source-tab:hover { border-color: var(--text-sub); }
    .source-tab.active { background: var(--accent); border-color: var(--accent); color: #fff; }

    .api-filter-bar { display: flex; gap: 4px; margin-bottom: 16px; flex-wrap: wrap; }
    .api-filter-btn {
      padding: 5px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;
      background: transparent; border: 1px solid var(--border); color: var(--text-sub); transition: all 0.15s;
    }
    .api-filter-btn.active { background: rgba(124,92,252,0.15); border-color: var(--accent); color: var(--accent); }
    .api-filter-btn:hover { border-color: var(--text-sub); }

    .sync-bar {
      display: flex; gap: 8px; align-items: center; flex-wrap: wrap;
      margin-bottom: 20px; padding: 14px 18px;
      background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius);
    }
    .sync-bar h2 { font-size: 18px; margin-right: auto; }

    @media (max-width: 768px) {
      .container { padding: 16px; }
      .post-grid { grid-template-columns: 1fr; }
      .stat-grid { grid-template-columns: 1fr 1fr; }
      .country-grid { grid-template-columns: 1fr; }
      .api-grid { grid-template-columns: 1fr; }
      .action-row { flex-direction: column; }
      .action-row .form-group { min-width: 100%; }
      .curate-row { flex-direction: column; }
      .country-filter { flex-wrap: wrap; }
      .main-nav { overflow-x: auto; }
    }
  </style>
</head>
<body>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-box">
    <div class="spinner"></div>
    <span id="loadingText">Processing...</span>
  </div>
</div>

<!-- â”€â”€â”€ Login Screen â”€â”€â”€ -->
<div class="login-wrap" id="loginScreen">
  <div class="login-box">
    <h1>Daydate Admin</h1>
    <p>ê´€ë¦¬ ëŒ€ì‹œë³´ë“œì— ë¡œê·¸ì¸í•˜ì„¸ìš”</p>
    <div class="form-group">
      <label>Email</label>
      <input type="email" id="loginEmail" placeholder="admin@example.com" />
    </div>
    <div class="form-group">
      <label>Password</label>
      <input type="password" id="loginPassword" placeholder="********" />
    </div>
    <div id="loginError" class="error-msg" style="display:none"></div>
    <button class="btn btn-primary btn-full" style="margin-top:16px" onclick="handleLogin()">
      Login
    </button>
  </div>
</div>

<!-- â”€â”€â”€ App â”€â”€â”€ -->
<div class="app" id="appScreen">
  <!-- Header -->
  <div class="header">
    <h1>Daydate Admin</h1>
    <div class="header-right">
      <span class="user-email" id="userEmail"></span>
      <button class="btn btn-outline btn-sm" onclick="handleLogout()">Logout</button>
    </div>
  </div>

  <!-- Main Navigation -->
  <div class="main-nav" id="mainNav">
    <div class="main-nav-item active" data-section="feed" onclick="switchMainNav(this)">í”¼ë“œ ê´€ë¦¬</div>
    <div class="main-nav-item" data-section="create" onclick="switchMainNav(this)">í”¼ë“œ ì œì‘</div>
    <div class="main-nav-item" data-section="top" onclick="switchMainNav(this)">Top ê´€ë¦¬</div>
    <div class="main-nav-item" data-section="countries" onclick="switchMainNav(this)">êµ­ê°€ë³„ í”¼ë“œ</div>
    <div class="main-nav-item" data-section="automation" onclick="switchMainNav(this)">ìë™í™” ëª¨ë‹ˆí„°ë§</div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- SECTION: í”¼ë“œ ê´€ë¦¬ -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="main-section active" id="section-feed">
    <div class="container">
      <!-- Sync Bar -->
      <div class="sync-bar" style="flex-wrap:wrap;gap:6px">
        <h2>í”¼ë“œ ê´€ë¦¬</h2>
        <button class="btn btn-primary btn-sm" id="btnSyncAll" onclick="syncAllFeeds()">ğŸ”„ ì „ì²´ Sync</button>
        <button class="btn btn-outline btn-sm" id="btnSyncKopis" onclick="syncKopis()">ğŸ­ KOPIS</button>
        <button class="btn btn-outline btn-sm" id="btnSyncTourApi" onclick="syncTourApi()">ğŸ—ºï¸ TourAPI</button>
        <button class="btn btn-outline btn-sm" id="btnSyncKcisaAll" onclick="syncKcisa('all')">ğŸ›ï¸ KCISA</button>
        <button class="btn btn-outline btn-sm" id="btnSyncKcisaShow" onclick="syncKcisa('show_festival')" style="font-size:11px">ğŸ­ ê³µì—°/ì¶•ì œ</button>
        <button class="btn btn-outline btn-sm" id="btnSyncKcisaExhibition" onclick="syncKcisa('exhibition')" style="font-size:11px">ğŸ–¼ï¸ ì „ì‹œ</button>
        <button class="btn btn-outline btn-sm" id="btnSyncKcisaSports" onclick="syncKcisa('sports')" style="font-size:11px">âš½ ìŠ¤í¬ì¸ </button>
        <button class="btn btn-outline btn-sm" id="btnSyncOlympic" onclick="syncOlympic()">ğŸŸï¸ ì˜¬ë¦¼í”½ê³µì›</button>
        <button class="btn btn-sm" id="btnRunBot3" onclick="runBot3()" style="background:#6366f1;color:#fff">ğŸ¤– ë´‡3</button>
        <button class="btn btn-sm" id="btnRunBot4" onclick="runBot4()" style="background:#6366f1;color:#fff">ğŸŸï¸ ë´‡4</button>
        <button class="btn btn-orange btn-sm" id="btnCleanExpired" onclick="cleanExpiredEvents()">ğŸ—‘ ë§Œë£Œ ì •ë¦¬ <span id="expiredCount" style="font-size:11px"></span></button>
      </div>

      <!-- Card News Panel -->
      <div class="action-panel collapsed" id="panelCardNews">
        <div class="action-panel-header" onclick="togglePanel('panelCardNews')">
          <h3>Card News (ì¹´ë“œë‰´ìŠ¤ í”¼ë“œ)</h3>
          <span class="collapse-icon">â–¼</span>
        </div>
        <div class="action-panel-body">
        <p style="font-size:13px;color:var(--text-sub);margin-bottom:14px;margin-top:14px">
          ë²šê½ƒ ê°œí™” ì‹œê¸°, ë‚˜ë“¤ì´ ëª…ì†Œ ë“± ì´ë¯¸ì§€+ìº¡ì…˜ë§Œ ìˆëŠ” ì •ë³´ì„± ì¹´ë“œë‰´ìŠ¤ë¥¼ ë§Œë“­ë‹ˆë‹¤. í•˜ë‹¨ ë²„íŠ¼(ì˜ˆë§¤/ìì„¸íˆë³´ê¸°) ì—†ì´ í‘œì‹œë©ë‹ˆë‹¤.
        </p>
        <div class="curate-section">
          <span class="section-label">Images</span>
          <div class="image-upload-zone" id="cardNewsDropZone">
            <input type="file" id="cardNewsImages" accept="image/jpeg,image/png,image/webp" multiple style="display:none" />
            <div class="upload-placeholder" id="cardNewsUploadPlaceholder" onclick="document.getElementById('cardNewsImages').click()">
              <span class="upload-icon">ğŸ–¼ï¸</span>
              <span>Click or drag images here (max 5)</span>
            </div>
            <div class="image-preview-grid" id="cardNewsPreviewGrid"></div>
          </div>
        </div>
        <div class="curate-section">
          <span class="section-label">Content</span>
          <div class="form-group" style="margin-bottom:12px">
            <label>Title <span style="color:var(--accent)">*</span></label>
            <input type="text" id="cardNewsTitle" placeholder="ì˜ˆ: 2026 ë²šê½ƒ ê°œí™” ì‹œê¸° ì´ì •ë¦¬" />
          </div>
          <div class="form-group" style="margin-bottom:12px">
            <label>Description (GPT ìº¡ì…˜ ìƒì„±ì— ì‚¬ìš©)</label>
            <textarea id="cardNewsCaption" rows="4" placeholder="ì¹´ë“œë‰´ìŠ¤ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
          </div>
        </div>
        <div class="curate-section">
          <span class="section-label">Classification</span>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
            <div>
              <label>Country</label>
              <input type="text" id="cardNewsCountry" value="KR" placeholder="ì˜ˆ: KR, US, JP" maxlength="2" style="text-transform:uppercase" />
            </div>
            <div>
              <label>Category</label>
              <select id="cardNewsCategory">
                <option value="spot">spot (ëª…ì†Œ/ì¥ì†Œ)</option>
                <option value="festival">festival (ì¶•ì œ/ì‹œì¦Œ)</option>
                <option value="activity">activity (í™œë™)</option>
                <option value="restaurant">restaurant (ë§›ì§‘)</option>
              </select>
            </div>
          </div>
        </div>
        <div style="display:flex;gap:8px">
          <button class="btn btn-primary" style="flex:1" onclick="saveCardNewsDraft()">Save as Draft</button>
          <button class="btn btn-green" style="flex:1" onclick="publishCardNews()">Save &amp; Publish (GPT ìº¡ì…˜)</button>
        </div>
        </div>
      </div>

      <!-- Source Sub-tabs -->
      <div class="source-tabs" id="feedSourceTabs">
        <div class="source-tab active" data-source="all" onclick="switchFeedSource(this)">ì „ì²´</div>
        <div class="source-tab" data-source="api" onclick="switchFeedSource(this)">API í”¼ë“œ</div>
        <div class="source-tab" data-source="bot" onclick="switchFeedSource(this)">ë´‡ í”¼ë“œ</div>
      </div>

      <!-- API Source Filter (shown when API í”¼ë“œ selected) -->
      <div class="api-filter-bar" id="apiSourceFilter" style="display:none">
        <button class="api-filter-btn active" data-api="all" onclick="switchApiSource(this)">ì „ì²´ API</button>
        <button class="api-filter-btn" data-api="kopis" onclick="switchApiSource(this)">ğŸ­ KOPIS</button>
        <button class="api-filter-btn" data-api="tourapi" onclick="switchApiSource(this)">ğŸ—ºï¸ TourAPI</button>
        <button class="api-filter-btn" data-api="kcisa" onclick="switchApiSource(this)">ğŸ›ï¸ KCISA</button>
        <button class="api-filter-btn" data-api="ticketmaster" onclick="switchApiSource(this)">ğŸ« Ticketmaster</button>
        <button class="api-filter-btn" data-api="eventbrite" onclick="switchApiSource(this)">ğŸª Eventbrite</button>
      </div>

      <!-- â”€â”€ Feed Posts View (ì „ì²´ / API) â”€â”€ -->
      <div id="feedPostsView">
        <div class="tabs" id="feedStatusTabs">
          <div class="tab active" data-status="all" onclick="switchTab(this)">All</div>
          <div class="tab" data-status="published" onclick="switchTab(this)">Published</div>
          <div class="tab" data-status="draft" onclick="switchTab(this)">Draft</div>
        </div>
        <div class="country-filter" id="countryFilterBar">
          <button class="country-btn active" data-country="all" onclick="switchCountry(this)">All</button>
          <button class="country-btn" data-country="KR" onclick="switchCountry(this)">ğŸ‡°ğŸ‡· KR</button>
          <button class="country-btn" data-country="US" onclick="switchCountry(this)">ğŸ‡ºğŸ‡¸ US</button>
          <button class="country-btn" data-country="JP" onclick="switchCountry(this)">ğŸ‡¯ğŸ‡µ JP</button>
          <button class="country-btn" data-country="TW" onclick="switchCountry(this)">ğŸ‡¹ğŸ‡¼ TW</button>
          <button class="country-btn" data-country="ES" onclick="switchCountry(this)">ğŸ‡ªğŸ‡¸ ES</button>
        </div>
        <div class="toolbar">
          <div class="toolbar-left">
            <span class="count-badge" id="postCount">0 posts</span>
            <label style="font-size:13px;display:flex;align-items:center;gap:6px;color:var(--text-sub);cursor:pointer">
              <input type="checkbox" id="selectAll" onchange="toggleSelectAll()" style="accent-color:var(--accent)" />
              Select All
            </label>
          </div>
          <div class="toolbar-right">
            <span id="selectedCount" style="font-size:13px;color:var(--accent);font-weight:500"></span>
            <button class="btn btn-green btn-sm" id="btnBulkPublish" onclick="bulkPublish()" style="display:none">Publish Selected</button>
            <button class="btn btn-orange btn-sm" id="btnBulkUnpublish" onclick="bulkUnpublish()" style="display:none">Unpublish Selected</button>
            <button class="btn btn-red btn-sm" id="btnBulkDelete" onclick="bulkDelete()" style="display:none">Delete Selected</button>
            <button class="btn btn-outline btn-sm" onclick="loadPosts()">Refresh</button>
          </div>
        </div>
        <div class="post-grid" id="postGrid"></div>
      </div>

      <!-- â”€â”€ Bot Feed View (ë´‡ í”¼ë“œ) â”€â”€ -->
      <div id="botFeedView" style="display:none">
        <div class="stat-grid" id="botFeedStats"></div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px">
          <button class="btn btn-primary" onclick="runBot3()">ğŸ›ï¸ ë´‡3 ì‹¤í–‰ (íŒì—…/ë§ˆì¼“/ì˜í™”)</button>
          <button class="btn btn-primary" onclick="runBot4()">ğŸŸï¸ ë´‡4 ì‹¤í–‰ (ìŠ¤í¬ì¸ )</button>
          <button class="btn btn-green btn-sm" onclick="bulkVerifyBotFeed()">âœ… ë¯¸ê²€ì¦ ì „ì²´ ìŠ¹ì¸</button>
          <button class="btn btn-red btn-sm" onclick="deleteAllBotFeed()">ğŸ—‘ ì „ì²´ ì‚­ì œ</button>
          <button class="btn btn-outline btn-sm" onclick="loadBotFeed()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
        </div>
        <div class="tabs" id="botFeedTabs">
          <div class="tab active" data-cat="all" onclick="switchBotFeedTab(this)">ì „ì²´</div>
          <div class="tab" data-cat="popup" onclick="switchBotFeedTab(this)">ğŸ›ï¸ íŒì—…ìŠ¤í† ì–´</div>
          <div class="tab" data-cat="market" onclick="switchBotFeedTab(this)">ğŸ›’ í”Œë¦¬ë§ˆì¼“</div>
          <div class="tab" data-cat="movie_special" onclick="switchBotFeedTab(this)">ğŸ¬ íŠ¹ë³„ìƒì˜</div>
          <div class="tab" data-cat="sports" onclick="switchBotFeedTab(this)">ğŸŸï¸ ìŠ¤í¬ì¸ </div>
          <div class="tab" data-cat="concert" onclick="switchBotFeedTab(this)">ğŸµ ê³µì—°</div>
          <div class="tab" data-cat="exhibition" onclick="switchBotFeedTab(this)">ğŸ¨ ì „ì‹œ</div>
          <div class="tab" data-cat="festival" onclick="switchBotFeedTab(this)">ğŸª ì¶•ì œ</div>
        </div>
        <div class="toolbar">
          <div class="toolbar-left">
            <span class="count-badge" id="botFeedCount">0ê±´</span>
            <select id="botFeedVerifyFilter" onchange="loadBotFeed()" style="padding:6px 10px;background:var(--surface2);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:13px">
              <option value="all">ì „ì²´ ìƒíƒœ</option>
              <option value="unverified">ë¯¸ê²€ì¦ë§Œ</option>
              <option value="verified">ê²€ì¦ë¨ë§Œ</option>
            </select>
            <select id="botFeedRegionFilter" onchange="loadBotFeed()" style="padding:6px 10px;background:var(--surface2);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:13px">
              <option value="all">ì „ì²´ ì§€ì—­</option>
              <option value="seoul">ì„œìš¸</option>
              <option value="gyeonggi">ê²½ê¸°</option>
              <option value="incheon">ì¸ì²œ</option>
              <option value="daejeon">ëŒ€ì „</option>
              <option value="busan">ë¶€ì‚°</option>
              <option value="daegu">ëŒ€êµ¬</option>
              <option value="gwangju">ê´‘ì£¼</option>
              <option value="other">ê¸°íƒ€</option>
            </select>
          </div>
        </div>
        <div class="post-grid" id="botFeedGrid"></div>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- SECTION: í”¼ë“œ ì œì‘ -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="main-section" id="section-create">
    <div class="container">
      <h2 style="margin-bottom:16px">í”¼ë“œ ì œì‘</h2>

      <!-- Manual Curation Panel -->
      <div class="action-panel collapsed" id="panelCuration">
        <div class="action-panel-header" onclick="togglePanel('panelCuration')">
          <h3>ìˆ˜ë™ ì´ë²¤íŠ¸ ë“±ë¡</h3>
          <span class="collapse-icon">â–¼</span>
        </div>
        <div class="action-panel-body">
        <p style="font-size:13px;color:var(--text-sub);margin-bottom:14px;margin-top:14px">
          YES24, nol ë“±ì—ì„œ ì°¾ì€ ì¶•ì œ/ê³µì—°ì„ ì§ì ‘ ë“±ë¡í•©ë‹ˆë‹¤. ì˜ˆë§¤ë§í¬ëŠ” ìë™ìœ¼ë¡œ ì œíœ´ë§í¬(LinkPrice)ë¡œ ë³€í™˜ë©ë‹ˆë‹¤.
        </p>
        <div class="curate-section">
          <span class="section-label">Images</span>
          <div class="image-upload-zone" id="imageDropZone">
            <input type="file" id="curateImages" accept="image/jpeg,image/png,image/webp" multiple style="display:none" />
            <div class="upload-placeholder" id="uploadPlaceholder" onclick="document.getElementById('curateImages').click()">
              <span class="upload-icon">ğŸ“·</span>
              <span>Click or drag images here (max 5)</span>
              <span class="upload-hint">JPG, PNG, WebP</span>
            </div>
            <div class="image-preview-grid" id="imagePreview"></div>
          </div>
        </div>
        <div class="curate-section">
          <span class="section-label">Event Info</span>
          <div class="form-group" style="margin-bottom:12px">
            <label>Title (ì´ë²¤íŠ¸ëª…) *</label>
            <input type="text" id="curateTitle" placeholder="ì˜ˆ: 2026 ì„œìš¸ ì¬ì¦ˆ í˜ìŠ¤í‹°ë²Œ" />
          </div>
          <div class="form-group" style="margin-bottom:12px">
            <label>Description (ì„¤ëª… - GPT ìº¡ì…˜ ìƒì„±ìš©)</label>
            <textarea id="curateCaption" rows="3" placeholder="ì´ë²¤íŠ¸ íŠ¹ì§•, ë¶„ìœ„ê¸°, ì¶”ì²œ í¬ì¸íŠ¸ ë“±...&#10;ì˜ˆ: ì˜¬ë¦¼í”½ê³µì› ì•¼ì™¸ë¬´ëŒ€, ì„¸ê³„ì  ì¬ì¦ˆ ì•„í‹°ìŠ¤íŠ¸ ë¼ì¸ì—…, ì»¤í”Œ ì¶”ì²œ"></textarea>
          </div>
          <div class="curate-row">
            <div class="form-group" style="flex:1">
              <label>Location (ì¥ì†Œ)</label>
              <input type="text" id="curateLocation" placeholder="ì˜ˆ: ì˜¬ë¦¼í”½ê³µì› 88ì”ë””ë§ˆë‹¹" />
            </div>
            <div class="form-group" style="flex:1">
              <label>Price (ê°€ê²©)</label>
              <input type="text" id="curatePrice" placeholder="ì˜ˆ: ë¬´ë£Œ / 55,000ì›~" />
            </div>
          </div>
          <div class="curate-row">
            <div class="form-group" style="flex:1">
              <label>Start Date (ì‹œì‘ì¼)</label>
              <input type="date" id="curateStartDate" />
            </div>
            <div class="form-group" style="flex:1">
              <label>End Date (ì¢…ë£Œì¼)</label>
              <input type="date" id="curateEndDate" />
            </div>
          </div>
          <div class="form-group" style="margin-top:8px">
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
              <input type="checkbox" id="curateIsFree" style="accent-color:var(--accent);width:18px;height:18px" onchange="onCurateFreeChange()" />
              ë¬´ë£Œ ì´ë²¤íŠ¸ (Free event)
            </label>
          </div>
        </div>
        <div class="curate-section">
          <span class="section-label">Links</span>
          <div class="form-group" style="margin-bottom:12px">
            <label>ì˜ˆë§¤ ë§í¬ (Booking URL) - ìë™ ì œíœ´ë§í¬ ë³€í™˜</label>
            <input type="url" id="curateBookingUrl" placeholder="https://ticket.yes24.com/... ë˜ëŠ” https://nol.yanolja.com/..." />
            <span style="font-size:11px;color:var(--text-sub);margin-top:4px;display:block">YES24, nol(ì•¼ë†€ì), Klook, KKday ë§í¬ â†’ LinkPrice ì œíœ´ë§í¬ë¡œ ìë™ ë³€í™˜</span>
          </div>
          <div class="form-group">
            <label>ì •ë³´ ë§í¬ (Info URL) - ì„ íƒì‚¬í•­</label>
            <input type="url" id="curateInfoUrl" placeholder="https://www.festival-website.com (ì´ë²¤íŠ¸ ê³µì‹ ì‚¬ì´íŠ¸ ë“±)" />
          </div>
        </div>
        <div class="curate-section">
          <span class="section-label">Classification</span>
          <div class="curate-row">
            <div class="form-group" style="flex:1">
              <label>Country</label>
              <input type="text" id="curateCountry" value="KR" placeholder="ì˜ˆ: KR, US, JP" maxlength="2" style="text-transform:uppercase" />
            </div>
            <div class="form-group" style="flex:1">
              <label>Category</label>
              <select id="curateCategory">
                <option value="festival">festival</option>
                <option value="show">show</option>
                <option value="tv_audience">tv_audience (ë°©ì²­)</option>
                <option value="activity">activity</option>
                <option value="popup">popup (íŒì—…ìŠ¤í† ì–´)</option>
                <option value="experience">experience (ì „ì‹œ/ì²´í—˜)</option>
                <option value="restaurant">restaurant</option>
                <option value="spot">spot</option>
                <option value="pet">pet</option>
                <option value="sports">sports (ìš´ë™Â·ìŠ¤í¬ì¸ )</option>
              </select>
            </div>
          </div>
        </div>
        <div class="curate-section">
          <span class="section-label">Targeting (ì„ íƒ)</span>
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer;margin-bottom:10px">
            <input type="checkbox" id="curateAnniversaryTarget" style="accent-color:var(--accent);width:18px;height:18px" onchange="toggleAnniversaryOptions()" />
            ê¸°ë…ì¼ íƒ€ê²ŸíŒ… (ê¸°ë…ì¼ ê°€ê¹Œìš´ ìœ ì €ì—ê²Œë§Œ ë…¸ì¶œ)
          </label>
          <div id="anniversaryOptions" style="display:none;padding-left:4px">
            <div style="display:flex;gap:16px;margin-bottom:10px">
              <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:13px">
                <input type="checkbox" id="curateTargetAnniversary" checked style="accent-color:var(--accent)" />
                ì—°ì•  ê¸°ë…ì¼
              </label>
              <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:13px">
                <input type="checkbox" id="curateTargetWedding" style="accent-color:var(--accent)" />
                ê²°í˜¼ ê¸°ë…ì¼
              </label>
            </div>
            <div class="form-group" style="margin-bottom:0">
              <label style="font-size:13px">D-day ë©°ì¹  ì „ë¶€í„° ë…¸ì¶œ</label>
              <input type="number" id="curateTargetDaysBefore" value="14" min="1" max="60" style="width:80px" />
              <span style="font-size:11px;color:var(--text-sub);margin-top:4px;display:block">ì˜ˆ: 14 â†’ ê¸°ë…ì¼ 2ì£¼ ì „ë¶€í„° í”¼ë“œ ìƒë‹¨ì— ë…¸ì¶œ, ê¸°ë…ì¼ ì§€ë‚˜ë©´ ìë™ ìˆ¨ê¹€</span>
            </div>
          </div>
        </div>
        <div style="display:flex;gap:8px">
          <button class="btn btn-primary" style="flex:1" onclick="curatePost()">Save as Draft</button>
          <button class="btn btn-green" style="flex:1" onclick="curateAndPublish()">Save &amp; Publish (GPT ìº¡ì…˜)</button>
        </div>
        </div>
      </div>

      <!-- Instagram Feed Panel (íŒì—…ìŠ¤í† ì–´ ìˆ˜ë™ ë“±ë¡) -->
      <div class="action-panel collapsed" id="panelInstagram">
        <div class="action-panel-header" onclick="togglePanel('panelInstagram')">
          <h3>íŒì—…ìŠ¤í† ì–´ ìˆ˜ë™ ë“±ë¡ (Instagram Feed)</h3>
          <span class="collapse-icon">â–¼</span>
        </div>
        <div class="action-panel-body">
        <p style="font-size:13px;color:var(--text-sub);margin-bottom:14px;margin-top:14px">
          Instagram URLì„ ì…ë ¥í•˜ê³  ì¸ë„¤ì¼ ì´ë¯¸ì§€ë¥¼ ì²¨ë¶€í•˜ì—¬ íŒì—…ìŠ¤í† ì–´/í–‰ì‚¬ í”¼ë“œë¥¼ ë§Œë“­ë‹ˆë‹¤. Instagram ë§í¬ëŠ” ì™¸ë¶€ë§í¬ë¡œ ì—°ê²°ë©ë‹ˆë‹¤.
        </p>
        <div class="curate-section">
          <span class="section-label">Instagram</span>
          <div class="form-group" style="margin-bottom:12px">
            <label>Instagram URL <span style="color:var(--accent)">*</span></label>
            <input type="url" id="igUrl" placeholder="https://www.instagram.com/p/... ë˜ëŠ” https://www.instagram.com/reel/..." />
            <span style="font-size:11px;color:var(--text-sub);margin-top:4px;display:block">ê²Œì‹œë¬¼, ë¦´ìŠ¤, í”„ë¡œí•„ URL ëª¨ë‘ ê°€ëŠ¥</span>
          </div>
        </div>
        <div class="curate-section">
          <span class="section-label">Thumbnail Image</span>
          <div class="image-upload-zone" id="igDropZone">
            <input type="file" id="igImages" accept="image/jpeg,image/png,image/webp" multiple style="display:none" />
            <div class="upload-placeholder" id="igUploadPlaceholder" onclick="document.getElementById('igImages').click()">
              <span class="upload-icon">ğŸ“¸</span>
              <span>ì¸ë„¤ì¼ ì´ë¯¸ì§€ë¥¼ ì²¨ë¶€í•˜ì„¸ìš” (max 5)</span>
              <span class="upload-hint">JPG, PNG, WebP</span>
            </div>
            <div class="image-preview-grid" id="igPreviewGrid"></div>
          </div>
        </div>
        <div class="curate-section">
          <span class="section-label">Event Info</span>
          <div class="form-group" style="margin-bottom:12px">
            <label>Title (í–‰ì‚¬ëª…) <span style="color:var(--accent)">*</span></label>
            <input type="text" id="igTitle" placeholder="ì˜ˆ: ë‚˜ì´í‚¤ íŒì—…ìŠ¤í† ì–´ ì„±ìˆ˜" />
          </div>
          <div class="form-group" style="margin-bottom:12px">
            <label>Description (ì„¤ëª… - GPT ìº¡ì…˜ ìƒì„±ìš©)</label>
            <textarea id="igCaption" rows="3" placeholder="í–‰ì‚¬ íŠ¹ì§•, ë¶„ìœ„ê¸°, ì¶”ì²œ í¬ì¸íŠ¸ ë“±..."></textarea>
          </div>
          <div class="curate-row">
            <div class="form-group" style="flex:1"><label>Location (ì¥ì†Œ)</label><input type="text" id="igLocation" placeholder="ì˜ˆ: ì„œìš¸ ì„±ìˆ˜ë™" /></div>
            <div class="form-group" style="flex:1"><label>Price (ê°€ê²©)</label><input type="text" id="igPrice" placeholder="ì˜ˆ: ë¬´ë£Œ / ì…ì¥ë£Œ 5,000ì›" /></div>
          </div>
          <div class="curate-row">
            <div class="form-group" style="flex:1"><label>Start Date (ì‹œì‘ì¼)</label><input type="date" id="igStartDate" /></div>
            <div class="form-group" style="flex:1"><label>End Date (ì¢…ë£Œì¼)</label><input type="date" id="igEndDate" /></div>
          </div>
          <div class="form-group" style="margin-top:8px">
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
              <input type="checkbox" id="igIsFree" checked style="accent-color:var(--accent);width:18px;height:18px" />
              ë¬´ë£Œ ì´ë²¤íŠ¸ (Free event)
            </label>
          </div>
        </div>
        <div class="curate-section">
          <span class="section-label">Classification</span>
          <div class="curate-row">
            <div class="form-group" style="flex:1">
              <label>Country</label>
              <input type="text" id="igCountry" value="KR" placeholder="ì˜ˆ: KR, US, JP" maxlength="2" style="text-transform:uppercase" />
            </div>
            <div class="form-group" style="flex:1">
              <label>Category</label>
              <select id="igCategory">
                <option value="popup" selected>popup (íŒì—…ìŠ¤í† ì–´)</option>
                <option value="experience">experience (ì „ì‹œ/ì²´í—˜)</option>
                <option value="festival">festival</option>
                <option value="activity">activity</option>
                <option value="show">show</option>
                <option value="restaurant">restaurant</option>
                <option value="spot">spot</option>
              </select>
            </div>
          </div>
        </div>
        <div style="display:flex;gap:8px">
          <button class="btn btn-primary" style="flex:1" onclick="saveInstagramDraft()">Save as Draft</button>
          <button class="btn btn-green" style="flex:1" onclick="publishInstagram()">Save &amp; Publish (GPT ìº¡ì…˜)</button>
        </div>
        </div>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- SECTION: Top ê´€ë¦¬ -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="main-section" id="section-top">
    <div class="container">
      <h2 style="margin-bottom:8px">ì¹´í…Œê³ ë¦¬ë³„ Top 5 ê´€ë¦¬</h2>
      <p style="color:var(--text-sub);font-size:13px;margin-bottom:20px">
        ê° ì¹´í…Œê³ ë¦¬ ì„¹ì…˜ì˜ Top 1~5ë¥¼ ì„ íƒí•©ë‹ˆë‹¤. Priority ê°’ì´ ë†’ì„ìˆ˜ë¡ ìƒìœ„ì— ë…¸ì¶œë©ë‹ˆë‹¤.
      </p>

      <!-- Section Tabs -->
      <div class="tabs" id="topSectionTabs">
        <div class="tab active" data-top-section="show_festival" onclick="switchTopSection(this)">ğŸ­ ê³µì—°Â·ì¶•ì œÂ·ë°©ì²­</div>
        <div class="tab" data-top-section="exhibition_popup" onclick="switchTopSection(this)">ğŸ¨ ì „ì‹œÂ·íŒì—…</div>
        <div class="tab" data-top-section="activity" onclick="switchTopSection(this)">ğŸ„ ì•¡í‹°ë¹„í‹°</div>
        <div class="tab" data-top-section="sports" onclick="switchTopSection(this)">âš½ ìš´ë™Â·ìŠ¤í¬ì¸ </div>
      </div>

      <!-- Current Top 5 -->
      <div class="action-panel" style="margin-bottom:20px">
        <h3 style="margin-bottom:14px">í˜„ì¬ Top 5 <span id="topSectionLabel" style="color:var(--accent)"></span></h3>
        <div id="topCurrentList" style="display:flex;flex-direction:column;gap:8px">
          <p style="color:var(--text-sub);font-size:13px">Loading...</p>
        </div>
      </div>

      <!-- Available Posts for Top Selection -->
      <div class="toolbar">
        <div class="toolbar-left">
          <span class="count-badge" id="topAvailableCount">0 posts</span>
          <span style="font-size:13px;color:var(--text-sub)">Published í¬ìŠ¤íŠ¸ë§Œ í‘œì‹œ</span>
        </div>
      </div>
      <div class="post-grid" id="topPostGrid"></div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- SECTION: êµ­ê°€ë³„ í”¼ë“œ -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="main-section" id="section-countries">
    <div class="container">
      <!-- Country Overview (ì¹´ë“œ ê·¸ë¦¬ë“œ) -->
      <div id="countriesOverview">
        <h2 style="margin-bottom:16px">êµ­ê°€ë³„ í”¼ë“œ í˜„í™©</h2>
        <div class="stat-grid" id="countrySummaryStats"></div>
        <div class="country-grid" id="countryCards">
          <p style="color:var(--text-sub)">Loading...</p>
        </div>
      </div>
      <!-- Country Detail (í¬ìŠ¤íŠ¸ ê·¸ë¦¬ë“œ) -->
      <div id="countryDetail" style="display:none">
        <button class="back-btn" onclick="showCountriesOverview()">â† êµ­ê°€ ëª©ë¡ìœ¼ë¡œ</button>
        <h2 id="countryDetailTitle" style="margin-bottom:16px"></h2>
        <div class="country-filter" id="countryDetailCategoryFilter"></div>
        <div class="toolbar">
          <div class="toolbar-left">
            <span class="count-badge" id="countryPostCount">0 posts</span>
            <label style="font-size:13px;display:flex;align-items:center;gap:6px;color:var(--text-sub);cursor:pointer">
              <input type="checkbox" id="countrySelectAll" onchange="toggleCountrySelectAll()" style="accent-color:var(--accent)" />
              Select All
            </label>
          </div>
          <div class="toolbar-right">
            <span id="countrySelectedCount" style="font-size:13px;color:var(--accent);font-weight:500"></span>
            <button class="btn btn-green btn-sm" id="btnCountryBulkPublish" onclick="countryBulkPublish()" style="display:none">Publish</button>
            <button class="btn btn-orange btn-sm" id="btnCountryBulkUnpublish" onclick="countryBulkUnpublish()" style="display:none">Unpublish</button>
            <button class="btn btn-red btn-sm" id="btnCountryBulkDelete" onclick="countryBulkDelete()" style="display:none">Delete</button>
          </div>
        </div>
        <div class="post-grid" id="countryPostGrid"></div>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- SECTION: ìë™í™” ëª¨ë‹ˆí„°ë§ -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="main-section" id="section-automation">
    <div class="container">
      <h2 style="margin-bottom:16px">ìë™í™” ëª¨ë‹ˆí„°ë§</h2>

      <!-- Cron Jobs -->
      <div class="action-panel">
        <h3 style="margin-bottom:14px">Cron Jobs (ì˜ˆì•½ ì‘ì—…)</h3>
        <div style="overflow-x:auto">
          <table class="data-table" id="cronJobsTable">
            <thead>
              <tr>
                <th>Job Name</th>
                <th>Schedule</th>
                <th>Description</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="cronJobsBody">
              <tr><td colspan="4" style="color:var(--text-sub)">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Edge Functions -->
      <div class="action-panel" style="margin-top:24px">
        <h3 style="margin-bottom:14px">Edge Functions (ë°°í¬ëœ í•¨ìˆ˜)</h3>
        <div style="overflow-x:auto">
          <table class="data-table" id="edgeFunctionsTable">
            <thead>
              <tr>
                <th>Function Name</th>
                <th>Category</th>
                <th>Description</th>
              </tr>
            </thead>
            <tbody id="edgeFunctionsBody"></tbody>
          </table>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="action-panel" style="margin-top:24px">
        <h3 style="margin-bottom:14px">Quick Actions</h3>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn btn-primary" onclick="syncKopis()">KOPIS Sync</button>
          <button class="btn btn-primary" onclick="syncTourApi()">TourAPI Sync</button>
          <button class="btn btn-primary" onclick="syncKcisa('all')">KCISA ì „ì²´ Sync</button>
          <button class="btn btn-orange" onclick="cleanExpiredEvents()">Clean Expired Events</button>
          <button class="btn btn-outline" onclick="loadDashboardData()">Refresh Dashboard</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- â”€â”€â”€ Edit Modal â”€â”€â”€ -->
<div class="modal-overlay" id="editModal">
  <div class="modal">
    <h2>Edit Post</h2>
    <input type="hidden" id="editId" />
    <div class="form-group">
      <label>Title</label>
      <input type="text" id="editTitle" />
    </div>
    <div class="form-group">
      <label>Caption</label>
      <textarea id="editCaption" rows="4"></textarea>
    </div>
    <div class="form-group">
      <label>Category</label>
      <select id="editCategory">
        <option value="show">show</option>
        <option value="festival">festival</option>
        <option value="tv_audience">tv_audience (ë°©ì²­)</option>
        <option value="activity">activity</option>
        <option value="popup">popup (íŒì—…ìŠ¤í† ì–´)</option>
        <option value="experience">experience (ì „ì‹œ/ì²´í—˜)</option>
        <option value="restaurant">restaurant</option>
        <option value="spot">spot</option>
        <option value="pet">pet</option>
        <option value="sports">sports (ìš´ë™Â·ìŠ¤í¬ì¸ )</option>
      </select>
    </div>
    <div class="form-group">
      <label>Country</label>
      <select id="editCountry">
        <option value="KR">ğŸ‡°ğŸ‡· Korea</option>
        <option value="US">ğŸ‡ºğŸ‡¸ United States</option>
        <option value="JP">ğŸ‡¯ğŸ‡µ Japan</option>
        <option value="TW">ğŸ‡¹ğŸ‡¼ Taiwan</option>
        <option value="ES">ğŸ‡ªğŸ‡¸ Spain</option>
        <option value="MX">ğŸ‡²ğŸ‡½ Mexico</option>
      </select>
    </div>
    <div class="form-group">
      <label>Location</label>
      <input type="text" id="editLocation" />
    </div>
    <div class="form-group">
      <label>Price</label>
      <input type="text" id="editPrice" />
    </div>
    <div class="form-group">
      <label>External Link</label>
      <input type="url" id="editLink" />
    </div>
    <div class="form-group">
      <label>Tags (comma separated)</label>
      <input type="text" id="editTags" />
    </div>
    <div class="form-group">
      <label>Images (JSON array of URLs)</label>
      <textarea id="editImages" rows="3" style="font-family:monospace;font-size:12px"></textarea>
    </div>
    <div class="form-group">
      <label>Priority (higher = more visible)</label>
      <input type="number" id="editPriority" value="0" />
    </div>
    <div class="form-group">
      <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
        <input type="checkbox" id="editIsFree" style="accent-color:var(--accent);width:18px;height:18px" />
        ë¬´ë£Œ ê³µì—°/ì´ë²¤íŠ¸ (Free event)
      </label>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeEditModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveEdit()">Save</button>
    </div>
  </div>
</div>

<!-- â”€â”€â”€ Detail Modal â”€â”€â”€ -->
<div class="modal-overlay" id="detailModal">
  <div class="modal" style="max-width:720px">
    <div id="detailContent"></div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeDetailModal()">Close</button>
    </div>
  </div>
</div>

<!-- â”€â”€â”€ Bot Event Detail/Edit Modal â”€â”€â”€ -->
<div class="modal-overlay" id="botEventModal">
  <div class="modal" style="max-width:700px">
    <div id="botEventModalContent"></div>
  </div>
</div>

<script>
// â”€â”€â”€ Config â”€â”€â”€
const SUPABASE_URL = 'https://olhdwsfhbghpeatzgurp.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9saGR3c2ZoYmdocGVhdHpndXJwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2NzMwODcsImV4cCI6MjA4MDI0OTA4N30.Zt4H3OeZtIg7YfEOEwIyNN89XucV9iuyBQ7mOtLuBq8';
const EDGE_BASE = `${SUPABASE_URL}/functions/v1`;
const CACHE_TTL_HOURS = 24;

const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let currentTab = 'all';
let currentCountry = 'all';
let currentFeedSource = 'all'; // 'all' | 'api' | 'bot'
let currentApiSource = 'all'; // 'all' | 'kopis' | 'tourapi' | 'kcisa' | 'ticketmaster' | 'eventbrite'
let posts = [];
let selectedIds = new Set();
let dashboardData = null;

// Country detail state
let countryDetailCode = null;
let countryDetailCategory = 'all';
let countryDetailPosts = [];
let countrySelectedIds = new Set();

const COUNTRY_FLAGS = {
  KR: 'ğŸ‡°ğŸ‡·', US: 'ğŸ‡ºğŸ‡¸', JP: 'ğŸ‡¯ğŸ‡µ', TW: 'ğŸ‡¹ğŸ‡¼', ES: 'ğŸ‡ªğŸ‡¸',
  VN: 'ğŸ‡»ğŸ‡³', TH: 'ğŸ‡¹ğŸ‡­', SG: 'ğŸ‡¸ğŸ‡¬', PH: 'ğŸ‡µğŸ‡­', ID: 'ğŸ‡®ğŸ‡©',
  MY: 'ğŸ‡²ğŸ‡¾', KH: 'ğŸ‡°ğŸ‡­', IN: 'ğŸ‡®ğŸ‡³', FR: 'ğŸ‡«ğŸ‡·', DE: 'ğŸ‡©ğŸ‡ª',
  IT: 'ğŸ‡®ğŸ‡¹', GB: 'ğŸ‡¬ğŸ‡§', AU: 'ğŸ‡¦ğŸ‡º', CA: 'ğŸ‡¨ğŸ‡¦', BR: 'ğŸ‡§ğŸ‡·', MX: 'ğŸ‡²ğŸ‡½',
};
const COUNTRY_NAMES = {
  KR: 'South Korea', US: 'United States', JP: 'Japan', TW: 'Taiwan', ES: 'Spain',
  VN: 'Vietnam', TH: 'Thailand', SG: 'Singapore', PH: 'Philippines', ID: 'Indonesia',
  MY: 'Malaysia', KH: 'Cambodia', IN: 'India', FR: 'France', DE: 'Germany',
  IT: 'Italy', GB: 'United Kingdom', AU: 'Australia', CA: 'Canada', BR: 'Brazil', MX: 'Mexico',
};
const COUNTRY_LANG_MAP = { KR: 'ko', US: 'en', JP: 'ja', TW: 'zh-TW', ES: 'es', MX: 'es', FR: 'fr', DE: 'de', IT: 'it', BR: 'pt' };
function countryFlag(code) { return COUNTRY_FLAGS[code] || 'ğŸŒ'; }
function countryName(code) { return COUNTRY_NAMES[code] || code; }

// Edge Function descriptions (static)
const EDGE_FUNCTIONS = [
  { name: 'feed-admin', category: 'Feed', desc: 'í”¼ë“œ í¬ìŠ¤íŠ¸ CRUD ê´€ë¦¬ (list, publish, update, delete, bulk)' },
  { name: 'feed-sync-kopis', category: 'Feed Sync', desc: 'KOPIS ê³µì—°/ì¶•ì œ ìë™ ìˆ˜ì§‘ (ê³µì—°DB + ì¶•ì œDB)' },
  { name: 'feed-sync-tourapi', category: 'Feed Sync', desc: 'TourAPI í•œêµ­ê´€ê´‘ê³µì‚¬ ì¶•ì œ/í–‰ì‚¬ ìˆ˜ì§‘' },
  { name: 'feed-sync-kcisa', category: 'Feed Sync', desc: 'KCISA ë¬¸í™”ê³µê³µë°ì´í„°ê´‘ì¥ ê³µì—°/ì „ì‹œ/ìŠ¤í¬ì¸  ìˆ˜ì§‘ (12ê°œ API)' },
  { name: 'feed-sync-events', category: 'Feed Sync', desc: 'Ticketmaster + Eventbrite í•´ì™¸ ì´ë²¤íŠ¸ ìˆ˜ì§‘ (24h ìºì‹œ)' },
  { name: 'feed-curate-instagram', category: 'Feed', desc: 'Instagram ì½˜í…ì¸  íë ˆì´ì…˜' },
  { name: 'feed-publish-posts', category: 'Feed', desc: 'GPT ìº¡ì…˜ ìë™ ìƒì„± + ê²Œì‹œ' },
  { name: 'admin-status', category: 'Admin', desc: 'ëŒ€ì‹œë³´ë“œ í†µê³„ ì§‘ê³„ API' },
  { name: 'plan-notifications', category: 'Notification', desc: 'í”Œëœ ì•Œë¦¼ ë°œì†¡ (í”„ë¦¬ë¯¸ì—„ ì „ìš© íƒ€ì… í¬í•¨)' },
  { name: 'send-push-notification', category: 'Notification', desc: 'ê°œë³„ í‘¸ì‹œ ì•Œë¦¼ ë°œì†¡' },
  { name: 'send-anniversary-notification', category: 'Notification', desc: 'ê¸°ë…ì¼ ì•Œë¦¼ (5ê°œ ì–¸ì–´, íƒ€ì„ì¡´ ì¸ì‹)' },
  { name: 'cleanup-couples', category: 'Cleanup', desc: '30ì¼ ì§€ë‚œ ì—°ê²°í•´ì œ ì»¤í”Œ ì˜êµ¬ ì‚­ì œ' },
  { name: 'cleanup-orphaned-photos', category: 'Cleanup', desc: 'ê³ ì•„ ì‚¬ì§„ íŒŒì¼ ìŠ¤í† ë¦¬ì§€ ì •ë¦¬' },
  { name: 'cleanup-orphaned-storage', category: 'Cleanup', desc: 'ë¯¸ì‚¬ìš© ìŠ¤í† ë¦¬ì§€ íŒŒì¼ ì •ë¦¬' },
  { name: 'delete-user-account', category: 'User', desc: 'ì‚¬ìš©ì ê³„ì • ì‚­ì œ (GDPR ì¤€ìˆ˜)' },
  { name: 'apple-server-notification', category: 'User', desc: 'Apple ê°œì¸ì •ë³´ ì½œë°± ì²˜ë¦¬ (í•œêµ­ ê°œì¸ì •ë³´ë³´í˜¸ë²•)' },
  { name: 'batch-collect-trending', category: 'Bot', desc: 'ë´‡3: ë„¤ì´ë²„ ë¸”ë¡œê·¸ + GPT â†’ íŒì—…/í”Œë¦¬ë§ˆì¼“/íŠ¹ë³„ìƒì˜ ìˆ˜ì§‘' },
  { name: 'batch-collect-sports', category: 'Bot', desc: 'ë´‡4: ë„¤ì´ë²„ ë‰´ìŠ¤ + GPT â†’ ìŠ¤í¬ì¸  ê²½ê¸° ìˆ˜ì§‘' },
  { name: 'update-feed-highlights', category: 'Bot', desc: 'ì£¼ë§ í•˜ì´ë¼ì´íŠ¸ Top5 ìë™ ì„ ì •' },
];

// Cron job descriptions
const CRON_DESCRIPTIONS = {
  'feed-sync-kopis-daily': 'KOPIS ê³µì—°/ì¶•ì œ ì¼ì¼ ìë™ ë™ê¸°í™”',
  'cleanup-expired-feed-posts': 'ë§Œë£Œëœ í”¼ë“œ í¬ìŠ¤íŠ¸ ìë™ ì‚­ì œ',
  'cleanup-disconnected-couples-daily': '30ì¼ ì§€ë‚œ ì—°ê²°í•´ì œ ì»¤í”Œ ì‚­ì œ',
  'cleanup-expired-pairing-codes': 'ë§Œë£Œ í˜ì–´ë§ ì½”ë“œ ì •ë¦¬',
  'expire-subscriptions': 'í”„ë¦¬ë¯¸ì—„ êµ¬ë… ë§Œë£Œ ì²˜ë¦¬',
  'plan-notifications-hourly': 'í”Œëœ ê´€ë ¨ ì•Œë¦¼ ë°œì†¡',
  'send-anniversary-notifications': 'ê¸°ë…ì¼ ì•Œë¦¼ ë°œì†¡',
  'cleanup-orphaned-storage-daily': 'ë¯¸ì‚¬ìš© ìŠ¤í† ë¦¬ì§€ ì¼ì¼ ì •ë¦¬',
  'batch-collect-trending': 'ë´‡3: íŒì—…/í”Œë¦¬ë§ˆì¼“/íŠ¹ë³„ìƒì˜ ìë™ ìˆ˜ì§‘ (ë§¤ì¼ 04:00 KST)',
  'batch-collect-sports': 'ë´‡4: ìŠ¤í¬ì¸  ê²½ê¸° ìë™ ìˆ˜ì§‘ (ë§¤ì£¼ ì›”,ëª© 05:00 KST)',
  'update-feed-highlights-weekly': 'í•˜ì´ë¼ì´íŠ¸ Top5 ìë™ ì„ ì • (ë§¤ì£¼ ìˆ˜ 05:00 KST)',
};

// â”€â”€â”€ Auth â”€â”€â”€
async function isAdmin(email) {
  const { data } = await sb.from('admin_users').select('id').eq('email', email).maybeSingle();
  return !!data;
}

async function checkSession() {
  const { data: { session } } = await sb.auth.getSession();
  if (session) {
    if (!(await isAdmin(session.user.email))) {
      await sb.auth.signOut();
      return;
    }
    showApp(session.user);
  }
}

async function handleLogin() {
  const email = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPassword').value;
  const errEl = document.getElementById('loginError');
  errEl.style.display = 'none';
  if (!email || !password) { errEl.textContent = 'Email and password are required'; errEl.style.display = 'block'; return; }
  const { data, error } = await sb.auth.signInWithPassword({ email, password });
  if (error) { errEl.textContent = error.message; errEl.style.display = 'block'; return; }
  if (!(await isAdmin(email))) { await sb.auth.signOut(); errEl.textContent = 'Access denied'; errEl.style.display = 'block'; return; }
  showApp(data.user);
}

async function handleLogout() {
  await sb.auth.signOut();
  document.getElementById('appScreen').style.display = 'none';
  document.getElementById('loginScreen').style.display = 'flex';
}

function showApp(user) {
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('appScreen').style.display = 'block';
  document.getElementById('userEmail').textContent = user.email;
  loadPosts();
  checkExpiredCount();
  refreshCountryFilter();
  loadDashboardData();
}

// â”€â”€â”€ Main Navigation â”€â”€â”€
function switchMainNav(el) {
  document.querySelectorAll('.main-nav-item').forEach(i => i.classList.remove('active'));
  el.classList.add('active');
  const section = el.dataset.section;
  document.querySelectorAll('.main-section').forEach(s => s.classList.remove('active'));
  document.getElementById(`section-${section}`).classList.add('active');

  // Load section-specific data
  if (section === 'feed') loadPosts();
  if (section === 'top') loadTopSection();
  if (section === 'countries' && dashboardData) renderCountriesSection();
  if (section === 'automation') renderAutomationSection();
}

// â”€â”€â”€ Dashboard Data â”€â”€â”€
async function loadDashboardData() {
  try {
    const headers = await getAuthHeaders();
    const res = await fetch(`${EDGE_BASE}/admin-status`, { headers });
    if (!res.ok) throw new Error('Failed to load dashboard data');
    dashboardData = await res.json();
    // Render sections if currently visible
    const activeSection = document.querySelector('.main-section.active')?.id;
    if (activeSection === 'section-countries') renderCountriesSection();
    if (activeSection === 'section-automation') renderAutomationSection();
  } catch (e) {
    console.error('[Dashboard]', e);
  }
}

// â”€â”€â”€ API helpers â”€â”€â”€
async function getAuthHeaders() {
  const { data: { session } } = await sb.auth.getSession();
  if (!session) { toast('Session expired. Please re-login.', 'error'); handleLogout(); throw new Error('No session'); }
  return { 'Authorization': `Bearer ${session.access_token}`, 'Content-Type': 'application/json' };
}

async function callAdmin(action, method = 'GET', body = null) {
  const headers = await getAuthHeaders();
  const opts = { method, headers };
  let url = `${EDGE_BASE}/feed-admin?action=${action}`;
  if (method === 'GET' && body) { for (const [k, v] of Object.entries(body)) url += `&${k}=${encodeURIComponent(v)}`; }
  if (method === 'POST' && body) { opts.body = JSON.stringify(body); }
  const res = await fetch(url, opts);
  const data = await res.json();
  if (!res.ok) throw new Error(data.error || 'Request failed');
  return data;
}

// â”€â”€â”€ Load Posts â”€â”€â”€
async function loadPosts() {
  try {
    const params = { status: currentTab, limit: '200', offset: '0' };
    if (currentCountry !== 'all') params.country_code = currentCountry;
    const result = await callAdmin('list', 'GET', params);
    let data = result.data || [];

    // Client-side source_type filtering
    const API_SOURCES = ['kopis', 'tourapi', 'kcisa', 'ticketmaster', 'eventbrite'];
    if (currentFeedSource === 'api') {
      data = data.filter(p => API_SOURCES.includes(p.source_type));
      if (currentApiSource !== 'all') {
        data = data.filter(p => p.source_type === currentApiSource);
      }
    }

    posts = data;
    renderPosts();
    refreshCountryFilter();
  } catch (e) { toast(e.message, 'error'); }
}

// â”€â”€â”€ Render Posts â”€â”€â”€
function renderPosts() {
  const grid = document.getElementById('postGrid');
  document.getElementById('postCount').textContent = `${posts.length} posts`;
  selectedIds.clear();
  updateBulkBtn();
  document.getElementById('selectAll').checked = false;
  if (posts.length === 0) {
    grid.innerHTML = '<p style="color:var(--text-sub);text-align:center;padding:40px;grid-column:1/-1">No posts found</p>';
    return;
  }
  grid.innerHTML = posts.map(p => renderPostCard(p, selectedIds)).join('');
}

function renderPostCard(p, selIds) {
  const images = p.images || [];
  const firstImg = images[0];
  const isPublished = p.is_published;
  const tags = (p.tags || []).slice(0, 3);
  const dateStr = p.event_start_date ? formatDate(p.event_start_date) : '';
  const endStr = p.event_end_date ? ` ~ ${formatDate(p.event_end_date)}` : '';
  return `
    <div class="post-card" data-id="${p.id}">
      <div class="post-card-img-wrap">
        <input type="checkbox" class="post-card-checkbox" value="${p.id}"
          ${selIds.has(p.id) ? 'checked' : ''}
          onchange="toggleSelect('${p.id}', this.checked)" />
        ${firstImg
          ? `<img class="post-card-img" src="${firstImg}" alt="${esc(p.title)}" onerror="this.parentElement.innerHTML='<div class=no-img>Image unavailable</div>'" />`
          : `<div class="no-img">No image</div>`}
      </div>
      <div class="post-card-body">
        <div class="post-card-title" title="${esc(p.title)}">${esc(p.title)}</div>
        <div class="post-card-caption">${esc(p.caption || '')}</div>
        <div class="post-card-meta">
          <span class="badge ${isPublished ? 'badge-published' : 'badge-draft'}">${isPublished ? 'Published' : 'Draft'}</span>
          <span class="badge badge-cat">${p.category || '-'}</span>
          ${p.country_code ? `<span class="badge badge-country">${countryFlag(p.country_code)} ${p.country_code}</span>` : ''}
          ${p.is_free ? `<span class="badge" style="background:rgba(52,211,153,0.15);color:var(--green)">FREE</span>` : ''}
          ${p.source_type ? `<span class="badge">${p.source_type}</span>` : ''}
          ${dateStr ? `<span class="badge">${dateStr}${endStr}</span>` : ''}
          ${images.length > 1 ? `<span class="badge">${images.length} imgs</span>` : ''}
        </div>
        ${tags.length ? `<div style="margin-bottom:10px">${tags.map(t => `<span style="font-size:11px;color:var(--accent);margin-right:6px">#${esc(t)}</span>`).join('')}</div>` : ''}
        <div class="post-card-actions">
          <button class="btn btn-outline btn-sm" onclick="viewDetail('${p.id}')">View</button>
          <button class="btn btn-outline btn-sm" onclick="openEditModal('${p.id}')">Edit</button>
          ${isPublished
            ? `<button class="btn btn-orange btn-sm" onclick="unpublishPost('${p.id}')">Unpublish</button>`
            : `<button class="btn btn-green btn-sm" onclick="publishPost('${p.id}')">Publish</button>`}
          <button class="btn btn-red btn-sm" onclick="deletePost('${p.id}')">Delete</button>
        </div>
      </div>
    </div>`;
}

function formatDate(dateStr) {
  if (!dateStr) return '';
  const d = new Date(dateStr);
  return `${d.getMonth() + 1}/${d.getDate()}`;
}

function esc(str) {
  if (!str) return '';
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// â”€â”€â”€ Tabs â”€â”€â”€
function switchTab(el) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  currentTab = el.dataset.status;
  loadPosts();
}

function switchCountry(el) {
  document.querySelectorAll('#countryFilterBar .country-btn').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
  currentCountry = el.dataset.country;
  loadPosts();
}

// â”€â”€â”€ Feed Source Tabs (ì „ì²´/API/ë´‡) â”€â”€â”€
function switchFeedSource(el) {
  document.querySelectorAll('#feedSourceTabs .source-tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  currentFeedSource = el.dataset.source;

  const feedPostsView = document.getElementById('feedPostsView');
  const botFeedView = document.getElementById('botFeedView');
  const apiFilter = document.getElementById('apiSourceFilter');

  if (currentFeedSource === 'bot') {
    feedPostsView.style.display = 'none';
    botFeedView.style.display = 'block';
    apiFilter.style.display = 'none';
    loadBotFeed();
  } else {
    feedPostsView.style.display = 'block';
    botFeedView.style.display = 'none';
    apiFilter.style.display = currentFeedSource === 'api' ? 'flex' : 'none';
    if (currentFeedSource === 'api') {
      currentApiSource = 'all';
      document.querySelectorAll('#apiSourceFilter .api-filter-btn').forEach(b => b.classList.remove('active'));
      document.querySelector('#apiSourceFilter .api-filter-btn[data-api="all"]').classList.add('active');
    }
    loadPosts();
  }
}

function switchApiSource(el) {
  document.querySelectorAll('#apiSourceFilter .api-filter-btn').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
  currentApiSource = el.dataset.api;
  loadPosts();
}

async function syncAllFeeds() {
  const btn = document.getElementById('btnSyncAll');
  btn.disabled = true;
  btn.innerHTML = '<div class="spinner"></div> Syncing...';
  showLoading('ì „ì²´ API Sync ì¤‘... (ìµœëŒ€ 3ë¶„ ì†Œìš”)');
  try {
    const headers = await getAuthHeaders();
    const results = [];

    // KOPIS
    try {
      const res = await fetch(`${EDGE_BASE}/feed-sync-kopis`, { method: 'POST', headers, body: JSON.stringify({}) });
      const data = await res.json();
      results.push(`KOPIS: ${data.inserted || 0}ê°œ ì¶”ê°€`);
    } catch (e) { results.push(`KOPIS: ì‹¤íŒ¨ (${e.message})`); }

    // TourAPI
    try {
      const res = await fetch(`${EDGE_BASE}/feed-sync-tourapi`, { method: 'POST', headers, body: JSON.stringify({}) });
      const data = await res.json();
      results.push(`TourAPI: ${data.inserted || 0}ê°œ ì¶”ê°€`);
    } catch (e) { results.push(`TourAPI: ì‹¤íŒ¨ (${e.message})`); }

    // KCISA
    try {
      const res = await fetch(`${EDGE_BASE}/feed-sync-kcisa`, { method: 'POST', headers, body: JSON.stringify({ group: 'all' }) });
      const data = await res.json();
      results.push(`KCISA: ${data.inserted || 0}ê°œ ì¶”ê°€`);
    } catch (e) { results.push(`KCISA: ì‹¤íŒ¨ (${e.message})`); }

    // ì˜¬ë¦¼í”½ê³µì›
    try {
      const res = await fetch(`${EDGE_BASE}/feed-sync-olympic`, { method: 'POST', headers, body: JSON.stringify({}) });
      const data = await res.json();
      results.push(`ì˜¬ë¦¼í”½ê³µì›: ${data.inserted || 0}ê°œ ì¶”ê°€`);
    } catch (e) { results.push(`ì˜¬ë¦¼í”½ê³µì›: ì‹¤íŒ¨ (${e.message})`); }

    alert('ì „ì²´ Sync ê²°ê³¼:\n' + results.join('\n'));
    toast('ì „ì²´ Sync ì™„ë£Œ', 'success');
    loadPosts(); loadDashboardData();
  } catch (e) { toast(e.message, 'error'); }
  finally { btn.disabled = false; btn.innerHTML = 'ğŸ”„ ì „ì²´ Sync'; hideLoading(); }
}

// â”€â”€â”€ Selection â”€â”€â”€
function toggleSelect(id, checked) {
  if (checked) selectedIds.add(id); else selectedIds.delete(id);
  updateBulkBtn();
}
function toggleSelectAll() {
  const checked = document.getElementById('selectAll').checked;
  document.querySelectorAll('#postGrid .post-card-checkbox').forEach(cb => {
    cb.checked = checked;
    if (checked) selectedIds.add(cb.value); else selectedIds.delete(cb.value);
  });
  updateBulkBtn();
}
function updateBulkBtn() {
  const show = selectedIds.size > 0;
  document.getElementById('btnBulkPublish').style.display = show ? 'inline-flex' : 'none';
  document.getElementById('btnBulkUnpublish').style.display = show ? 'inline-flex' : 'none';
  document.getElementById('btnBulkDelete').style.display = show ? 'inline-flex' : 'none';
  document.getElementById('selectedCount').textContent = show ? `${selectedIds.size} selected` : '';
}

// â”€â”€â”€ Actions â”€â”€â”€
async function publishPost(id) {
  const p = posts.find(x => x.id === id) || countryDetailPosts.find(x => x.id === id);
  const needsCaption = p && (!p.caption || p.caption.trim() === '');
  if (needsCaption) {
    showLoading('GPT ìº¡ì…˜ ìƒì„± + Publish ì¤‘...');
    try {
      const headers = await getAuthHeaders();
      const res = await fetch(`${EDGE_BASE}/feed-publish-posts`, { method: 'POST', headers, body: JSON.stringify({ postIds: [id] }) });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Publish failed');
      toast('Published with GPT caption!', 'success');
      reloadCurrentView();
    } catch (e) { toast(e.message, 'error'); }
    finally { hideLoading(); }
  } else {
    try { await callAdmin('publish', 'POST', { id }); toast('Published!', 'success'); reloadCurrentView(); }
    catch (e) { toast(e.message, 'error'); }
  }
}

async function unpublishPost(id) {
  try { await callAdmin('unpublish', 'POST', { id }); toast('Unpublished', 'success'); reloadCurrentView(); }
  catch (e) { toast(e.message, 'error'); }
}

async function deletePost(id) {
  if (!confirm('Are you sure you want to delete this post?')) return;
  try { await callAdmin('delete', 'POST', { id }); toast('Deleted', 'success'); reloadCurrentView(); }
  catch (e) { toast(e.message, 'error'); }
}

function reloadCurrentView() {
  const active = document.querySelector('.main-section.active')?.id;
  if (active === 'section-countries' && countryDetailCode) {
    loadCountryDetailPosts(countryDetailCode, countryDetailCategory);
  } else {
    loadPosts();
  }
  loadDashboardData();
}

async function bulkPublish() {
  if (selectedIds.size === 0) return;
  if (!confirm(`Publish ${selectedIds.size} posts?`)) return;
  const needGpt = [], haveCaption = [];
  for (const id of selectedIds) {
    const p = posts.find(x => x.id === id);
    if (p && (!p.caption || p.caption.trim() === '')) needGpt.push(id); else haveCaption.push(id);
  }
  showLoading(`Publishing ${selectedIds.size} posts...` + (needGpt.length > 0 ? ` (${needGpt.length}ê°œ GPT ìº¡ì…˜ ìƒì„±)` : ''));
  try {
    if (needGpt.length > 0) {
      const headers = await getAuthHeaders();
      const res = await fetch(`${EDGE_BASE}/feed-publish-posts`, { method: 'POST', headers, body: JSON.stringify({ postIds: needGpt }) });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'GPT publish failed');
      toast(`${data.published || 0} posts published with GPT caption`, 'success');
    }
    if (haveCaption.length > 0) {
      await callAdmin('bulk_publish', 'POST', { ids: haveCaption });
      toast(`${haveCaption.length} posts published`, 'success');
    }
    selectedIds.clear(); loadPosts(); loadDashboardData();
  } catch (e) { toast(e.message, 'error'); }
  finally { hideLoading(); }
}

async function bulkUnpublish() {
  if (selectedIds.size === 0) return;
  if (!confirm(`Unpublish ${selectedIds.size} posts?`)) return;
  showLoading(`Unpublishing ${selectedIds.size} posts...`);
  try {
    await callAdmin('bulk_unpublish', 'POST', { ids: Array.from(selectedIds) });
    toast(`${selectedIds.size} posts unpublished`, 'success');
    selectedIds.clear(); loadPosts(); loadDashboardData();
  } catch (e) { toast(e.message, 'error'); }
  finally { hideLoading(); }
}

async function bulkDelete() {
  if (selectedIds.size === 0) return;
  if (!confirm(`Delete ${selectedIds.size} posts permanently?`)) return;
  showLoading(`Deleting ${selectedIds.size} posts...`);
  try {
    await callAdmin('bulk_delete', 'POST', { ids: Array.from(selectedIds) });
    toast(`${selectedIds.size} posts deleted`, 'success');
    selectedIds.clear(); loadPosts(); loadDashboardData();
  } catch (e) { toast(e.message, 'error'); }
  finally { hideLoading(); }
}

// â”€â”€â”€ Detail â”€â”€â”€
function viewDetail(id) {
  const p = posts.find(x => x.id === id) || countryDetailPosts.find(x => x.id === id);
  if (!p) return;
  const images = p.images || [];
  const attrs = p.image_attributions || [];
  const tags = p.tags || [];
  document.getElementById('detailContent').innerHTML = `
    <h2 style="margin-bottom:16px">${esc(p.title)}</h2>
    ${images.length ? `<div style="display:flex;gap:8px;overflow-x:auto;margin-bottom:16px">
      ${images.map(img => `<img src="${img}" style="height:200px;border-radius:8px;object-fit:cover" onerror="this.style.display='none'" />`).join('')}
    </div>` : ''}
    <p style="color:var(--text-sub);line-height:1.6;margin-bottom:16px">${esc(p.caption)}</p>
    <table style="width:100%;font-size:13px;border-collapse:collapse">
      ${detailRow('ID', p.id)}${detailRow('Category', p.category)}
      ${detailRow('Country', p.country_code ? `${countryFlag(p.country_code)} ${p.country_code}` : '-')}
      ${detailRow('Source', p.source_type + (p.source_id ? ` (${p.source_id})` : ''))}
      ${detailRow('Status', p.is_published ? 'Published' : 'Draft')}
      ${detailRow('Location', p.location_name)}${detailRow('Price', p.price)}
      ${detailRow('Free', p.is_free ? '<span style="color:var(--green)">Yes</span>' : 'No')}
      ${detailRow('Event', p.event_start_date ? `${p.event_start_date} ~ ${p.event_end_date || ''}` : '-')}
      ${detailRow('External Link', p.external_link ? `<a href="${p.external_link}" target="_blank" style="color:var(--accent)">${p.external_link}</a>` : '-')}
      ${detailRow('Tags', tags.map(t => `#${esc(t)}`).join(' '))}
      ${detailRow('Priority', p.priority)}${detailRow('Save Count', p.save_count)}
      ${detailRow('Created', new Date(p.created_at).toLocaleString('ko-KR'))}
      ${detailRow('Updated', new Date(p.updated_at).toLocaleString('ko-KR'))}
    </table>
    ${attrs.length ? `<div style="margin-top:16px"><strong style="font-size:13px">Image Attributions:</strong>
      ${attrs.map(a => `<div style="font-size:12px;color:var(--text-sub);margin-top:4px">Photo by <a href="${a.photographerUrl}" target="_blank" style="color:var(--accent)">${esc(a.photographerName)}</a></div>`).join('')}
    </div>` : ''}`;
  document.getElementById('detailModal').classList.add('show');
}

function detailRow(label, value) {
  return `<tr><td style="padding:6px 8px;color:var(--text-sub);border-bottom:1px solid var(--border);white-space:nowrap;vertical-align:top">${label}</td><td style="padding:6px 8px;border-bottom:1px solid var(--border);word-break:break-all">${value || '-'}</td></tr>`;
}

function closeDetailModal() { document.getElementById('detailModal').classList.remove('show'); }

// â”€â”€â”€ Edit â”€â”€â”€
function openEditModal(id) {
  const p = posts.find(x => x.id === id) || countryDetailPosts.find(x => x.id === id);
  if (!p) return;
  document.getElementById('editId').value = p.id;
  document.getElementById('editTitle').value = p.title || '';
  document.getElementById('editCaption').value = p.caption || '';
  document.getElementById('editCategory').value = p.category || 'spot';
  document.getElementById('editCountry').value = p.country_code || 'KR';
  document.getElementById('editLocation').value = p.location_name || '';
  document.getElementById('editPrice').value = p.price || '';
  document.getElementById('editLink').value = p.external_link || '';
  document.getElementById('editTags').value = (p.tags || []).join(', ');
  document.getElementById('editImages').value = JSON.stringify(p.images || [], null, 2);
  document.getElementById('editPriority').value = p.priority || 0;
  document.getElementById('editIsFree').checked = !!p.is_free;
  document.getElementById('editModal').classList.add('show');
}

function closeEditModal() { document.getElementById('editModal').classList.remove('show'); }

async function saveEdit() {
  const id = document.getElementById('editId').value;
  let images;
  try { images = JSON.parse(document.getElementById('editImages').value); } catch { toast('Invalid images JSON', 'error'); return; }
  const tags = document.getElementById('editTags').value.split(',').map(t => t.trim()).filter(Boolean);
  const updates = {
    id, title: document.getElementById('editTitle').value, caption: document.getElementById('editCaption').value,
    category: document.getElementById('editCategory').value, country_code: document.getElementById('editCountry').value,
    language: COUNTRY_LANG_MAP[document.getElementById('editCountry').value] || 'ko',
    location_name: document.getElementById('editLocation').value, price: document.getElementById('editPrice').value,
    external_link: document.getElementById('editLink').value, tags, images,
    priority: parseInt(document.getElementById('editPriority').value) || 0,
    is_free: document.getElementById('editIsFree').checked,
  };
  try { await callAdmin('update', 'POST', updates); toast('Saved!', 'success'); closeEditModal(); reloadCurrentView(); }
  catch (e) { toast(e.message, 'error'); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COUNTRIES SECTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderCountriesSection() {
  if (!dashboardData) return;
  const stats = dashboardData.feed_stats;
  const countries = stats.by_country || [];

  // Summary stats
  document.getElementById('countrySummaryStats').innerHTML = `
    <div class="stat-card">
      <div class="stat-card-label">Total Posts</div>
      <div class="stat-card-value">${stats.total}</div>
      <div class="stat-card-sub">${stats.published} published / ${stats.draft} draft</div>
    </div>
    <div class="stat-card">
      <div class="stat-card-label">Countries</div>
      <div class="stat-card-value">${countries.length}</div>
    </div>
    <div class="stat-card">
      <div class="stat-card-label">Last 24h</div>
      <div class="stat-card-value">${dashboardData.recent_posts?.last_24h || 0}</div>
      <div class="stat-card-sub">new posts</div>
    </div>
    <div class="stat-card">
      <div class="stat-card-label">Last 7 Days</div>
      <div class="stat-card-value">${dashboardData.recent_posts?.last_7d || 0}</div>
      <div class="stat-card-sub">new posts</div>
    </div>`;

  // Country cards
  document.getElementById('countryCards').innerHTML = countries.map(c => {
    const cats = c.categories || {};
    const catBadges = Object.entries(cats).map(([cat, cnt]) =>
      `<span class="badge badge-cat">${cat}: ${cnt}</span>`
    ).join('');
    return `
      <div class="country-card" onclick="openCountryDetail('${c.country_code}')">
        <div class="country-card-header">
          <span class="country-card-flag">${countryFlag(c.country_code)}</span>
          <div>
            <div class="country-card-name">${countryName(c.country_code)}</div>
            <div class="country-card-code">${c.country_code}</div>
          </div>
        </div>
        <div class="country-card-stats">
          <div class="country-card-stat">
            <span class="country-card-stat-label">Total</span>
            <span>${c.count}</span>
          </div>
          <div class="country-card-stat">
            <span class="country-card-stat-label">Published</span>
            <span style="color:var(--green)">${c.published}</span>
          </div>
          <div class="country-card-stat">
            <span class="country-card-stat-label">Draft</span>
            <span style="color:var(--orange)">${c.count - c.published}</span>
          </div>
        </div>
        <div class="country-card-categories">${catBadges}</div>
      </div>`;
  }).join('');
}

async function openCountryDetail(code) {
  countryDetailCode = code;
  countryDetailCategory = 'all';
  document.getElementById('countriesOverview').style.display = 'none';
  document.getElementById('countryDetail').style.display = 'block';
  document.getElementById('countryDetailTitle').textContent = `${countryFlag(code)} ${countryName(code)} (${code})`;

  // Build category filter
  const c = dashboardData?.feed_stats?.by_country?.find(x => x.country_code === code);
  const cats = c?.categories || {};
  const filterHtml = `<button class="country-btn active" data-cat="all" onclick="switchCountryDetailCategory(this, '${code}')">All</button>`
    + Object.keys(cats).map(cat =>
      `<button class="country-btn" data-cat="${cat}" onclick="switchCountryDetailCategory(this, '${code}')">${cat} (${cats[cat]})</button>`
    ).join('');
  document.getElementById('countryDetailCategoryFilter').innerHTML = filterHtml;

  await loadCountryDetailPosts(code, 'all');
}

function showCountriesOverview() {
  countryDetailCode = null;
  document.getElementById('countriesOverview').style.display = 'block';
  document.getElementById('countryDetail').style.display = 'none';
}

async function switchCountryDetailCategory(el, code) {
  document.querySelectorAll('#countryDetailCategoryFilter .country-btn').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
  countryDetailCategory = el.dataset.cat;
  await loadCountryDetailPosts(code, countryDetailCategory);
}

async function loadCountryDetailPosts(code, category) {
  try {
    const params = { status: 'all', limit: '200', offset: '0', country_code: code };
    const result = await callAdmin('list', 'GET', params);
    let data = result.data || [];
    if (category && category !== 'all') {
      data = data.filter(p => p.category === category);
    }
    countryDetailPosts = data;
    countrySelectedIds.clear();
    renderCountryDetailPosts();
  } catch (e) { toast(e.message, 'error'); }
}

function renderCountryDetailPosts() {
  const grid = document.getElementById('countryPostGrid');
  document.getElementById('countryPostCount').textContent = `${countryDetailPosts.length} posts`;
  document.getElementById('countrySelectAll').checked = false;
  updateCountryBulkBtn();

  if (countryDetailPosts.length === 0) {
    grid.innerHTML = '<p style="color:var(--text-sub);text-align:center;padding:40px;grid-column:1/-1">No posts found</p>';
    return;
  }
  grid.innerHTML = countryDetailPosts.map(p => renderPostCard(p, countrySelectedIds)).join('');

  // Re-bind checkboxes to country selection
  grid.querySelectorAll('.post-card-checkbox').forEach(cb => {
    cb.onchange = function() {
      if (this.checked) countrySelectedIds.add(this.value); else countrySelectedIds.delete(this.value);
      updateCountryBulkBtn();
    };
  });
}

function toggleCountrySelectAll() {
  const checked = document.getElementById('countrySelectAll').checked;
  document.querySelectorAll('#countryPostGrid .post-card-checkbox').forEach(cb => {
    cb.checked = checked;
    if (checked) countrySelectedIds.add(cb.value); else countrySelectedIds.delete(cb.value);
  });
  updateCountryBulkBtn();
}

function updateCountryBulkBtn() {
  const show = countrySelectedIds.size > 0;
  document.getElementById('btnCountryBulkPublish').style.display = show ? 'inline-flex' : 'none';
  document.getElementById('btnCountryBulkUnpublish').style.display = show ? 'inline-flex' : 'none';
  document.getElementById('btnCountryBulkDelete').style.display = show ? 'inline-flex' : 'none';
  document.getElementById('countrySelectedCount').textContent = show ? `${countrySelectedIds.size} selected` : '';
}

async function countryBulkPublish() {
  if (countrySelectedIds.size === 0) return;
  if (!confirm(`Publish ${countrySelectedIds.size} posts?`)) return;
  showLoading(`Publishing ${countrySelectedIds.size} posts...`);
  try {
    const needGpt = [], haveCaption = [];
    for (const id of countrySelectedIds) {
      const p = countryDetailPosts.find(x => x.id === id);
      if (p && (!p.caption || p.caption.trim() === '')) needGpt.push(id); else haveCaption.push(id);
    }
    if (needGpt.length > 0) {
      const headers = await getAuthHeaders();
      const res = await fetch(`${EDGE_BASE}/feed-publish-posts`, { method: 'POST', headers, body: JSON.stringify({ postIds: needGpt }) });
      if (!res.ok) throw new Error('GPT publish failed');
    }
    if (haveCaption.length > 0) await callAdmin('bulk_publish', 'POST', { ids: haveCaption });
    toast(`${countrySelectedIds.size} posts published`, 'success');
    countrySelectedIds.clear();
    await loadCountryDetailPosts(countryDetailCode, countryDetailCategory);
    loadDashboardData();
  } catch (e) { toast(e.message, 'error'); }
  finally { hideLoading(); }
}

async function countryBulkUnpublish() {
  if (countrySelectedIds.size === 0) return;
  if (!confirm(`Unpublish ${countrySelectedIds.size} posts?`)) return;
  showLoading(`Unpublishing...`);
  try {
    await callAdmin('bulk_unpublish', 'POST', { ids: Array.from(countrySelectedIds) });
    toast(`${countrySelectedIds.size} posts unpublished`, 'success');
    countrySelectedIds.clear();
    await loadCountryDetailPosts(countryDetailCode, countryDetailCategory);
    loadDashboardData();
  } catch (e) { toast(e.message, 'error'); }
  finally { hideLoading(); }
}

async function countryBulkDelete() {
  if (countrySelectedIds.size === 0) return;
  if (!confirm(`Delete ${countrySelectedIds.size} posts permanently?`)) return;
  showLoading(`Deleting...`);
  try {
    await callAdmin('bulk_delete', 'POST', { ids: Array.from(countrySelectedIds) });
    toast(`${countrySelectedIds.size} posts deleted`, 'success');
    countrySelectedIds.clear();
    await loadCountryDetailPosts(countryDetailCode, countryDetailCategory);
    loadDashboardData();
  } catch (e) { toast(e.message, 'error'); }
  finally { hideLoading(); }
}

function timeAgo(dateStr) {
  const diff = Date.now() - new Date(dateStr).getTime();
  const mins = Math.floor(diff / 60000);
  if (mins < 60) return `${mins}m ago`;
  const hrs = Math.floor(mins / 60);
  if (hrs < 24) return `${hrs}h ago`;
  return `${Math.floor(hrs / 24)}d ago`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTOMATION SECTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAutomationSection() {
  // Cron jobs from dashboard data or fallback
  const cronJobs = dashboardData?.cron_jobs?.jobs || [];

  if (cronJobs.length > 0) {
    document.getElementById('cronJobsBody').innerHTML = cronJobs.map(job => `
      <tr>
        <td style="font-family:monospace;font-size:12px">${esc(job.jobname)}</td>
        <td style="font-family:monospace;font-size:12px">${esc(job.schedule)}</td>
        <td>${CRON_DESCRIPTIONS[job.jobname] || '-'}</td>
        <td>${job.active !== false
          ? '<span style="color:var(--green)">Active</span>'
          : '<span style="color:var(--red)">Inactive</span>'}</td>
      </tr>`).join('');
  } else {
    // Fallback: show known cron jobs
    const knownJobs = [
      { name: 'feed-sync-kopis-daily', schedule: '0 21 * * *', desc: 'KOPIS ê³µì—°/ì¶•ì œ ì¼ì¼ ë™ê¸°í™”' },
      { name: 'cleanup-expired-feed-posts', schedule: '0 18 * * *', desc: 'ë§Œë£Œ í”¼ë“œ í¬ìŠ¤íŠ¸ ì‚­ì œ' },
      { name: 'cleanup-disconnected-couples-daily', schedule: '0 18 * * *', desc: '30ì¼ ì§€ë‚œ ì»¤í”Œ ì‚­ì œ' },
      { name: 'cleanup-expired-pairing-codes', schedule: '0 * * * *', desc: 'ë§Œë£Œ í˜ì–´ë§ ì½”ë“œ ì •ë¦¬' },
      { name: 'expire-subscriptions', schedule: '0 0 * * *', desc: 'í”„ë¦¬ë¯¸ì—„ êµ¬ë… ë§Œë£Œ ì²˜ë¦¬' },
      { name: 'plan-notifications-hourly', schedule: '0 * * * *', desc: 'í”Œëœ ì•Œë¦¼ ë°œì†¡' },
      { name: 'send-anniversary-notifications', schedule: '0 * * * *', desc: 'ê¸°ë…ì¼ ì•Œë¦¼ ë°œì†¡' },
    ];
    document.getElementById('cronJobsBody').innerHTML = knownJobs.map(job => `
      <tr>
        <td style="font-family:monospace;font-size:12px">${job.name}</td>
        <td style="font-family:monospace;font-size:12px">${job.schedule}</td>
        <td>${job.desc}</td>
        <td><span style="color:var(--green)">Active</span></td>
      </tr>`).join('');
  }

  // Edge Functions table
  document.getElementById('edgeFunctionsBody').innerHTML = EDGE_FUNCTIONS.map(fn => `
    <tr>
      <td style="font-family:monospace;font-size:12px">${fn.name}</td>
      <td><span class="badge badge-cat">${fn.category}</span></td>
      <td>${fn.desc}</td>
    </tr>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SYNC FUNCTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function syncKopis() {
  const btn = document.getElementById('btnSyncKopis');
  const origText = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<div class="spinner"></div> Syncing...';
  showLoading('KOPIS API ë™ê¸°í™” ì¤‘... (ìµœëŒ€ 1ë¶„ ì†Œìš”)');
  try {
    const headers = await getAuthHeaders();
    const res = await fetch(`${EDGE_BASE}/feed-sync-kopis`, { method: 'POST', headers, body: JSON.stringify({}) });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || 'Sync failed');
    let msg = `Sync: ${data.inserted || 0} inserted, ${data.skippedDuplicates || 0} dupes, ${data.errors || 0} errors (total: ${data.totalFound || 0})`;
    if (data.debug) {
      const debugSummary = data.debug.map(d => `${d.config}: ${d.itemCount || d.dbCount || 0} items, status=${d.status}`).join('\n');
      msg += '\n\nDebug:\n' + debugSummary;
    }
    alert(msg);
    toast(`Sync: ${data.inserted || 0} inserted`, data.inserted > 0 ? 'success' : 'info');
    loadPosts(); loadDashboardData();
  } catch (e) { toast(e.message, 'error'); }
  finally { btn.disabled = false; btn.innerHTML = origText; hideLoading(); }
}

async function syncTourApi() {
  const btn = document.getElementById('btnSyncTourApi');
  const origText = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<div class="spinner"></div> Syncing...';
  showLoading('TourAPI ë™ê¸°í™” ì¤‘...');
  try {
    const headers = await getAuthHeaders();
    const res = await fetch(`${EDGE_BASE}/feed-sync-tourapi`, { method: 'POST', headers, body: JSON.stringify({}) });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || 'Sync failed');
    let msg = `TourAPI: ${data.inserted || 0}ê°œ Draft, ${data.skippedDuplicates || 0} ì¤‘ë³µ`;
    if (data.inserted > 0) msg += '\n\nDraft íƒ­ì—ì„œ í™•ì¸ í›„ Publishí•˜ì„¸ìš”.';
    alert(msg);
    toast(`TourAPI: ${data.inserted || 0}ê°œ Draft`, data.inserted > 0 ? 'success' : 'info');
    if (data.inserted > 0) {
      const draftTab = document.querySelector('.tab[data-status="draft"]');
      if (draftTab) switchTab(draftTab);
    }
    loadPosts(); loadDashboardData();
  } catch (e) { toast(e.message, 'error'); }
  finally { btn.disabled = false; btn.innerHTML = origText; hideLoading(); }
}


async function syncKcisa(group = 'all') {
  const groupLabels = { show_festival: 'ê³µì—°/ì¶•ì œ', exhibition: 'ì „ì‹œ', sports: 'ìŠ¤í¬ì¸ ', all: 'ì „ì²´' };
  const groupIcons = { show_festival: 'ğŸ­', exhibition: 'ğŸ–¼ï¸', sports: 'âš½', all: 'ğŸ›ï¸' };
  const label = groupLabels[group] || group;
  const icon = groupIcons[group] || '';
  const btnMap = { show_festival: 'btnSyncKcisaShow', exhibition: 'btnSyncKcisaExhibition', sports: 'btnSyncKcisaSports', all: 'btnSyncKcisaAll' };
  const btn = document.getElementById(btnMap[group]);
  const origBtnText = btn ? btn.innerHTML : '';
  if (btn) { btn.disabled = true; btn.innerHTML = '<div class="spinner"></div> Syncing...'; }
  showLoading(`KCISA ${label} ë™ê¸°í™” ì¤‘... (ìµœëŒ€ 2ë¶„ ì†Œìš”)`);
  try {
    const headers = await getAuthHeaders();
    const res = await fetch(`${EDGE_BASE}/feed-sync-kcisa`, {
      method: 'POST', headers,
      body: JSON.stringify({ group }),
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || 'Sync failed');
    let msg = `KCISA ${label}: ${data.inserted || 0}ê°œ Draft, ${data.skippedDuplicates || 0} ì¤‘ë³µ, ${data.errors || 0} ì—ëŸ¬`;
    if (data.results) {
      msg += '\n\nìƒì„¸:';
      data.results.forEach(r => {
        msg += `\n[${r.name}] ${r.fetched}ê±´ â†’ ${r.inserted}ê°œ ì‚½ì…, ${r.duplicates} ì¤‘ë³µ${r.error ? ', Error: ' + r.error : ''}`;
      });
    }
    if (data.inserted > 0) msg += '\n\nDraft íƒ­ì—ì„œ í™•ì¸ í›„ Publishí•˜ì„¸ìš”.';
    alert(msg);
    toast(`KCISA ${label}: ${data.inserted || 0}ê°œ Draft`, data.inserted > 0 ? 'success' : 'info');
    if (data.inserted > 0) {
      const draftTab = document.querySelector('.tab[data-status="draft"]');
      if (draftTab) switchTab(draftTab);
    }
    loadPosts(); loadDashboardData();
  } catch (e) { toast(e.message, 'error'); }
  finally {
    if (btn) { btn.disabled = false; btn.innerHTML = origBtnText; }
    hideLoading();
  }
}

async function syncOlympic() {
  const btn = document.getElementById('btnSyncOlympic');
  const origText = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<div class="spinner"></div> Syncing...';
  showLoading('ì˜¬ë¦¼í”½ê³µì› í–‰ì‚¬ í¬ë¡¤ë§ ì¤‘...');
  try {
    const headers = await getAuthHeaders();
    const res = await fetch(`${EDGE_BASE}/feed-sync-olympic`, { method: 'POST', headers, body: JSON.stringify({}) });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || 'Sync failed');
    let msg = `ì˜¬ë¦¼í”½ê³µì›: ${data.inserted || 0}ê°œ Draft, ${data.skippedDuplicates || 0} ì¤‘ë³µ, ${data.errors || 0} ì—ëŸ¬`;
    if (data.debug) {
      msg += '\n\nì›”ë³„ ìƒì„¸:';
      data.debug.forEach(d => {
        msg += `\n[${d.month}] ì˜ˆì • ${d.upcoming ?? 0}ê±´ + ì§€ë‚œ ${d.past ?? 0}ê±´${d.error ? ' Error: ' + d.error : ''}`;
      });
    }
    if (data.inserted > 0) msg += '\n\nDraft íƒ­ì—ì„œ í™•ì¸ í›„ Publishí•˜ì„¸ìš”.';
    alert(msg);
    toast(`ì˜¬ë¦¼í”½ê³µì›: ${data.inserted || 0}ê°œ Draft`, data.inserted > 0 ? 'success' : 'info');
    if (data.inserted > 0) {
      const draftTab = document.querySelector('.tab[data-status="draft"]');
      if (draftTab) switchTab(draftTab);
    }
    loadPosts(); loadDashboardData();
  } catch (e) { toast(e.message, 'error'); }
  finally { btn.disabled = false; btn.innerHTML = origText; hideLoading(); }
}

async function cleanExpiredEvents() {
  const btn = document.getElementById('btnCleanExpired');
  const origText = btn.innerHTML;
  btn.disabled = true; btn.textContent = 'Cleaning...';
  try {
    const today = new Date().toISOString().split('T')[0];
    const { count, error: countErr } = await sb.from('feed_posts').select('*', { count: 'exact', head: true }).lt('event_end_date', today);
    if (countErr) throw countErr;
    if (!count || count === 0) { toast('No expired events found', 'info'); return; }
    if (!confirm(`${count}ê°œì˜ ì§€ë‚œ ì´ë²¤íŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
    // ì‚­ì œ ì „ source_id ê¸°ë¡ (ì¬ìˆ˜ì§‘ ë°©ì§€)
    const { data: expiredPosts } = await sb.from('feed_posts').select('source_id, source_type, title, event_end_date').lt('event_end_date', today).not('source_id', 'is', null);
    if (expiredPosts && expiredPosts.length > 0) {
      const records = expiredPosts.filter(p => p.source_id).map(p => ({ source_id: p.source_id, source_type: p.source_type || null, title: p.title || null, event_end_date: p.event_end_date || null }));
      if (records.length > 0) await sb.from('feed_deleted_sources').upsert(records, { onConflict: 'source_id' });
    }
    const { error: delErr } = await sb.from('feed_posts').delete().lt('event_end_date', today);
    if (delErr) throw delErr;
    toast(`${count}ê°œ ì‚­ì œ ì™„ë£Œ`, 'success');
    loadPosts(); checkExpiredCount(); loadDashboardData();
  } catch (e) { toast(e.message, 'error'); }
  finally { btn.disabled = false; btn.innerHTML = origText; }
}

async function checkExpiredCount() {
  try {
    const today = new Date().toISOString().split('T')[0];
    const { count } = await sb.from('feed_posts').select('*', { count: 'exact', head: true }).lt('event_end_date', today);
    const el = document.getElementById('expiredCount');
    if (count > 0) { el.textContent = `(${count}ê°œ ë§Œë£Œë¨)`; el.style.color = '#EF4444'; }
    else { el.textContent = ''; }
  } catch {}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CURATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderImagePreviews() {
  const input = document.getElementById('curateImages');
  const preview = document.getElementById('imagePreview');
  const placeholder = document.getElementById('uploadPlaceholder');
  const files = Array.from(input.files).slice(0, 5);
  preview.innerHTML = '';
  if (files.length === 0) { placeholder.style.display = ''; return; }
  placeholder.style.display = 'none';
  files.forEach((file, i) => {
    const reader = new FileReader();
    reader.onload = (e) => {
      const item = document.createElement('div');
      item.className = 'preview-item';
      item.innerHTML = `<img src="${e.target.result}" /><button class="remove-btn" onclick="removePreviewImage(${i})">âœ•</button>`;
      preview.appendChild(item);
    };
    reader.readAsDataURL(file);
  });
}

function removePreviewImage(index) {
  const input = document.getElementById('curateImages');
  const dt = new DataTransfer();
  Array.from(input.files).forEach((file, i) => { if (i !== index) dt.items.add(file); });
  input.files = dt.files;
  renderImagePreviews();
}

function onCurateFreeChange() {
  const isFree = document.getElementById('curateIsFree').checked;
  const bookingInput = document.getElementById('curateBookingUrl');
  if (isFree) { bookingInput.value = ''; bookingInput.disabled = true; bookingInput.style.opacity = '0.4'; }
  else { bookingInput.disabled = false; bookingInput.style.opacity = '1'; }
}

function toggleAnniversaryOptions() {
  const checked = document.getElementById('curateAnniversaryTarget').checked;
  document.getElementById('anniversaryOptions').style.display = checked ? 'block' : 'none';
}

function getTargetConfig() {
  if (!document.getElementById('curateAnniversaryTarget').checked) return null;
  const types = [];
  if (document.getElementById('curateTargetAnniversary').checked) types.push('anniversary');
  if (document.getElementById('curateTargetWedding').checked) types.push('wedding');
  if (types.length === 0) return null;
  return {
    anniversary: {
      days_before: parseInt(document.getElementById('curateTargetDaysBefore').value) || 14,
      types,
    },
  };
}

function getCurateFormData() {
  return {
    title: document.getElementById('curateTitle').value.trim(),
    description: document.getElementById('curateCaption').value.trim(),
    location: document.getElementById('curateLocation').value.trim(),
    price: document.getElementById('curatePrice').value.trim(),
    startDate: document.getElementById('curateStartDate').value,
    endDate: document.getElementById('curateEndDate').value,
    isFree: document.getElementById('curateIsFree').checked,
    bookingUrl: document.getElementById('curateBookingUrl').value.trim(),
    infoUrl: document.getElementById('curateInfoUrl').value.trim(),
    category: document.getElementById('curateCategory').value,
    countryCode: document.getElementById('curateCountry').value.toUpperCase().trim(),
    language: COUNTRY_LANG_MAP[document.getElementById('curateCountry').value.toUpperCase().trim()] || 'ko',
    imageFiles: Array.from(document.getElementById('curateImages').files).slice(0, 5),
    targetConfig: getTargetConfig(),
  };
}

function resetCurateForm() {
  ['curateTitle','curateCaption','curateLocation','curatePrice','curateStartDate','curateEndDate','curateBookingUrl','curateInfoUrl'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('curateIsFree').checked = false;
  document.getElementById('curateBookingUrl').disabled = false;
  document.getElementById('curateBookingUrl').style.opacity = '1';
  document.getElementById('curateCategory').value = 'festival';
  document.getElementById('curateCountry').value = 'KR';
  document.getElementById('curateImages').value = '';
  document.getElementById('imagePreview').innerHTML = '';
  document.getElementById('uploadPlaceholder').style.display = '';
  document.getElementById('curateAnniversaryTarget').checked = false;
  document.getElementById('curateTargetAnniversary').checked = true;
  document.getElementById('curateTargetWedding').checked = false;
  document.getElementById('curateTargetDaysBefore').value = '14';
  document.getElementById('anniversaryOptions').style.display = 'none';
}

async function uploadFeedImages(files) {
  const urls = [];
  for (const file of files) {
    const ext = file.name.split('.').pop().toLowerCase();
    const fileName = `${Date.now()}_${Math.random().toString(36).slice(2, 8)}.${ext}`;
    const path = `curated/${fileName}`;
    const { data, error } = await sb.storage.from('feed-images').upload(path, file, { contentType: file.type, upsert: false });
    if (error) throw new Error(`Image upload failed: ${error.message}`);
    const { data: urlData } = sb.storage.from('feed-images').getPublicUrl(path);
    urls.push(urlData.publicUrl);
  }
  return urls;
}

async function curatePost() {
  const form = getCurateFormData();
  if (!form.title) { toast('Title is required', 'error'); return; }
  if (form.imageFiles.length === 0) { toast('At least one image is required', 'error'); return; }
  showLoading('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘...');
  try {
    const imageUrls = await uploadFeedImages(form.imageFiles);
    const insertData = {
      title: form.title, caption: '', overview: form.description || '', source_type: 'manual',
      images: imageUrls, location_name: form.location || null, price: form.price || null,
      event_start_date: form.startDate || null, event_end_date: form.endDate || null,
      external_link: form.bookingUrl || form.infoUrl || null, category: form.category,
      tags: [], is_published: false, publish_date: null, priority: 0,
      is_free: form.isFree, country_code: form.countryCode, language: form.language,
    };
    if (form.targetConfig) insertData.target_config = form.targetConfig;
    const { error } = await sb.from('feed_posts').insert(insertData);
    if (error) throw new Error(error.message);
    toast(`Draft saved: ${form.title}${form.targetConfig ? ' (ê¸°ë…ì¼ íƒ€ê²Ÿ)' : ''}`, 'success');
    resetCurateForm();
    const draftTab = document.querySelector('.tab[data-status="draft"]');
    if (draftTab) switchTab(draftTab); else loadPosts();
    loadDashboardData();
  } catch (e) { toast(e.message, 'error'); }
  finally { hideLoading(); }
}

async function curateAndPublish() {
  const form = getCurateFormData();
  if (!form.title) { toast('Title is required', 'error'); return; }
  if (form.imageFiles.length === 0) { toast('At least one image is required', 'error'); return; }
  showLoading('ì´ë¯¸ì§€ ì—…ë¡œë“œ + GPT ìº¡ì…˜ ìƒì„± ì¤‘...');
  try {
    const imageUrls = await uploadFeedImages(form.imageFiles);
    const insertData = {
      title: form.title, caption: '', overview: form.description || '', source_type: 'manual',
      images: imageUrls, location_name: form.location || null, price: form.price || null,
      event_start_date: form.startDate || null, event_end_date: form.endDate || null,
      external_link: form.bookingUrl || form.infoUrl || null, category: form.category,
      tags: [], is_published: false, publish_date: null, priority: 0,
      is_free: form.isFree, country_code: form.countryCode, language: form.language,
    };
    if (form.targetConfig) insertData.target_config = form.targetConfig;
    const { data: inserted, error: insertErr } = await sb.from('feed_posts').insert(insertData).select('id').single();
    if (insertErr) throw new Error(insertErr.message);
    const headers = await getAuthHeaders();
    const res = await fetch(`${EDGE_BASE}/feed-publish-posts`, {
      method: 'POST', headers, body: JSON.stringify({ postIds: [inserted.id] }),
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || 'Publish failed');
    toast(`Published: ${form.title}${form.targetConfig ? ' (ê¸°ë…ì¼ íƒ€ê²Ÿ)' : ''}`, 'success');
    resetCurateForm(); loadPosts(); loadDashboardData();
  } catch (e) { toast(e.message, 'error'); }
  finally { hideLoading(); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CARD NEWS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderCardNewsPreviews() {
  const input = document.getElementById('cardNewsImages');
  const preview = document.getElementById('cardNewsPreviewGrid');
  const placeholder = document.getElementById('cardNewsUploadPlaceholder');
  const files = Array.from(input.files).slice(0, 5);
  preview.innerHTML = '';
  if (files.length === 0) { placeholder.style.display = ''; return; }
  placeholder.style.display = 'none';
  files.forEach((file, i) => {
    const reader = new FileReader();
    reader.onload = (e) => {
      const item = document.createElement('div');
      item.className = 'preview-item';
      item.innerHTML = `<img src="${e.target.result}" /><button class="remove-btn" onclick="removeCardNewsImage(${i})">âœ•</button>`;
      preview.appendChild(item);
    };
    reader.readAsDataURL(file);
  });
}

function removeCardNewsImage(index) {
  const input = document.getElementById('cardNewsImages');
  const dt = new DataTransfer();
  Array.from(input.files).forEach((file, i) => { if (i !== index) dt.items.add(file); });
  input.files = dt.files;
  renderCardNewsPreviews();
}

function getCardNewsFormData() {
  const countryCode = document.getElementById('cardNewsCountry').value.toUpperCase().trim();
  return {
    title: document.getElementById('cardNewsTitle').value.trim(),
    description: document.getElementById('cardNewsCaption').value.trim(),
    category: document.getElementById('cardNewsCategory').value,
    countryCode,
    language: COUNTRY_LANG_MAP[countryCode] || 'ko',
    imageFiles: Array.from(document.getElementById('cardNewsImages').files).slice(0, 5),
  };
}

function resetCardNewsForm() {
  ['cardNewsTitle','cardNewsCaption'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('cardNewsCategory').value = 'spot';
  document.getElementById('cardNewsCountry').value = 'KR';
  document.getElementById('cardNewsImages').value = '';
  document.getElementById('cardNewsPreviewGrid').innerHTML = '';
  document.getElementById('cardNewsUploadPlaceholder').style.display = '';
}

async function saveCardNewsDraft() {
  const form = getCardNewsFormData();
  if (!form.title) { toast('Title is required', 'error'); return; }
  if (form.imageFiles.length === 0) { toast('At least one image is required', 'error'); return; }
  showLoading('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘...');
  try {
    const imageUrls = await uploadFeedImages(form.imageFiles);
    const { error } = await sb.from('feed_posts').insert({
      title: form.title, caption: '', overview: form.description || '', source_type: 'cardnews',
      images: imageUrls, location_name: null, price: null,
      event_start_date: null, event_end_date: null,
      external_link: null, category: form.category,
      tags: [], is_published: false, publish_date: null, priority: 0,
      is_free: false, country_code: form.countryCode, language: form.language,
    });
    if (error) throw new Error(error.message);
    toast(`Card News draft saved: ${form.title}`, 'success');
    resetCardNewsForm();
    const draftTab = document.querySelector('.tab[data-status="draft"]');
    if (draftTab) switchTab(draftTab); else loadPosts();
    loadDashboardData();
  } catch (e) { toast(e.message, 'error'); }
  finally { hideLoading(); }
}

async function publishCardNews() {
  const form = getCardNewsFormData();
  if (!form.title) { toast('Title is required', 'error'); return; }
  if (form.imageFiles.length === 0) { toast('At least one image is required', 'error'); return; }
  showLoading('ì´ë¯¸ì§€ ì—…ë¡œë“œ + GPT ìº¡ì…˜ ìƒì„± ì¤‘...');
  try {
    const imageUrls = await uploadFeedImages(form.imageFiles);
    const { data: inserted, error: insertErr } = await sb.from('feed_posts').insert({
      title: form.title, caption: '', overview: form.description || '', source_type: 'cardnews',
      images: imageUrls, location_name: null, price: null,
      event_start_date: null, event_end_date: null,
      external_link: null, category: form.category,
      tags: [], is_published: false, publish_date: null, priority: 0,
      is_free: false, country_code: form.countryCode, language: form.language,
    }).select('id').single();
    if (insertErr) throw new Error(insertErr.message);
    const headers = await getAuthHeaders();
    const res = await fetch(`${EDGE_BASE}/feed-publish-posts`, {
      method: 'POST', headers, body: JSON.stringify({ postIds: [inserted.id] }),
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || 'Publish failed');
    toast(`Card News published: ${form.title}`, 'success');
    resetCardNewsForm(); loadPosts(); loadDashboardData();
  } catch (e) { toast(e.message, 'error'); }
  finally { hideLoading(); }
}

// â”€â”€â”€ Toast / Loading â”€â”€â”€
function toast(msg, type = 'info') {
  const el = document.createElement('div');
  el.className = `toast toast-${type}`;
  el.textContent = msg;
  document.getElementById('toastContainer').appendChild(el);
  setTimeout(() => el.remove(), 4000);
}
function showLoading(text) { document.getElementById('loadingText').textContent = text || 'Processing...'; document.getElementById('loadingOverlay').classList.add('show'); }
function hideLoading() { document.getElementById('loadingOverlay').classList.remove('show'); }

// â”€â”€â”€ Close modals â”€â”€â”€
document.querySelectorAll('.modal-overlay').forEach(overlay => {
  overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.classList.remove('show'); });
});
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') document.querySelectorAll('.modal-overlay.show').forEach(m => m.classList.remove('show'));
});

// â”€â”€â”€ Collapsible Panels â”€â”€â”€
function togglePanel(panelId) { document.getElementById(panelId).classList.toggle('collapsed'); }

// â”€â”€â”€ Dynamic Country Filter â”€â”€â”€
const CORE_COUNTRIES = ['KR', 'US', 'JP', 'TW', 'ES'];
async function refreshCountryFilter() {
  try {
    const { data } = await sb.from('feed_posts').select('country_code').not('country_code', 'is', null);
    if (!data) return;
    const countryCodes = [...new Set(data.map(d => d.country_code))].filter(Boolean);
    const extraCountries = countryCodes.filter(c => !CORE_COUNTRIES.includes(c)).sort();
    const bar = document.getElementById('countryFilterBar');
    bar.querySelectorAll('.country-btn-dynamic').forEach(b => b.remove());
    for (const code of extraCountries) {
      const btn = document.createElement('button');
      btn.className = 'country-btn country-btn-dynamic';
      btn.dataset.country = code;
      btn.onclick = function() { switchCountry(this); };
      btn.textContent = `${countryFlag(code)} ${code}`;
      bar.appendChild(btn);
    }
  } catch {}
}

// â”€â”€â”€ Image Events â”€â”€â”€
document.getElementById('curateImages').addEventListener('change', renderImagePreviews);
const dropZone = document.getElementById('imageDropZone');
dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
dropZone.addEventListener('dragleave', () => { dropZone.classList.remove('dragover'); });
dropZone.addEventListener('drop', (e) => {
  e.preventDefault(); dropZone.classList.remove('dragover');
  const input = document.getElementById('curateImages');
  const dt = new DataTransfer();
  const existing = Array.from(input.files);
  const dropped = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'));
  [...existing, ...dropped].slice(0, 5).forEach(f => dt.items.add(f));
  input.files = dt.files;
  renderImagePreviews();
});

// â”€â”€â”€ Card News Image Events â”€â”€â”€
document.getElementById('cardNewsImages').addEventListener('change', renderCardNewsPreviews);
const cnDropZone = document.getElementById('cardNewsDropZone');
cnDropZone.addEventListener('dragover', (e) => { e.preventDefault(); cnDropZone.classList.add('dragover'); });
cnDropZone.addEventListener('dragleave', () => { cnDropZone.classList.remove('dragover'); });
cnDropZone.addEventListener('drop', (e) => {
  e.preventDefault(); cnDropZone.classList.remove('dragover');
  const input = document.getElementById('cardNewsImages');
  const dt = new DataTransfer();
  const existing = Array.from(input.files);
  const dropped = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'));
  [...existing, ...dropped].slice(0, 5).forEach(f => dt.items.add(f));
  input.files = dt.files;
  renderCardNewsPreviews();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOP MANAGEMENT SECTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const TOP_SECTIONS = {
  show_festival: { label: 'ê³µì—°Â·ì¶•ì œÂ·ë°©ì²­', categories: ['show', 'festival', 'tv_audience'] },
  exhibition_popup: { label: 'ì „ì‹œÂ·íŒì—…', categories: ['popup', 'experience'] },
  activity: { label: 'ì•¡í‹°ë¹„í‹°', categories: ['activity'] },
  sports: { label: 'ìš´ë™Â·ìŠ¤í¬ì¸ ', categories: ['sports'] },
};

let currentTopSection = 'show_festival';
let topPosts = [];

function switchTopSection(el) {
  document.querySelectorAll('#topSectionTabs .tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  currentTopSection = el.dataset.topSection;
  loadTopSection();
}

async function loadTopSection() {
  const config = TOP_SECTIONS[currentTopSection];
  if (!config) return;
  document.getElementById('topSectionLabel').textContent = config.label;

  try {
    // Fetch published posts for these categories (KR only)
    const allResults = [];
    for (const cat of config.categories) {
      const result = await callAdmin('list', 'GET', { status: 'published', limit: '50', offset: '0', country_code: 'KR', category: cat });
      if (result.data) allResults.push(...result.data);
    }
    topPosts = allResults.sort((a, b) => (b.priority || 0) - (a.priority || 0));
    renderTopSection();
  } catch (e) {
    toast(e.message, 'error');
  }
}

function renderTopSection() {
  // Current Top 5 (priority > 0, sorted desc)
  const topItems = topPosts.filter(p => (p.priority || 0) > 0).sort((a, b) => (b.priority || 0) - (a.priority || 0)).slice(0, 5);
  const listEl = document.getElementById('topCurrentList');

  if (topItems.length === 0) {
    listEl.innerHTML = '<p class="top-empty">Top 5ê°€ ì•„ì§ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì•„ë˜ í¬ìŠ¤íŠ¸ì—ì„œ Priorityë¥¼ ì„¤ì •í•˜ì„¸ìš”.</p>';
  } else {
    listEl.innerHTML = topItems.map((p, i) => `
      <div class="top-rank-item">
        <span class="top-rank-badge">TOP ${i + 1}</span>
        ${p.images?.[0] ? `<img src="${p.images[0]}" style="width:48px;height:48px;border-radius:6px;object-fit:cover" />` : ''}
        <div style="flex:1;min-width:0">
          <div class="top-rank-title">${esc(p.title)}</div>
          <span class="top-rank-category">${p.category}</span>
        </div>
        <div class="top-rank-priority">
          P: <input type="number" value="${p.priority || 0}" min="0" max="99"
            onchange="updateTopPriority('${p.id}', this.value)" />
        </div>
        <button class="btn btn-outline btn-sm" onclick="updateTopPriority('${p.id}', 0)" title="Topì—ì„œ ì œê±°">âœ•</button>
      </div>
    `).join('');
  }

  // Available posts grid
  const available = topPosts;
  document.getElementById('topAvailableCount').textContent = `${available.length} posts`;
  const grid = document.getElementById('topPostGrid');
  if (available.length === 0) {
    grid.innerHTML = '<p style="color:var(--text-sub);text-align:center;padding:40px;grid-column:1/-1">Published í¬ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤</p>';
    return;
  }

  grid.innerHTML = available.map(p => {
    const images = p.images || [];
    const firstImg = images[0];
    const dateStr = p.event_start_date ? formatDate(p.event_start_date) : '';
    const endStr = p.event_end_date ? ` ~ ${formatDate(p.event_end_date)}` : '';
    const isTop = (p.priority || 0) > 0;
    return `
      <div class="post-card" data-id="${p.id}" style="${isTop ? 'border-color:#FF4B6E' : ''}">
        <div class="post-card-img-wrap">
          ${firstImg
            ? `<img class="post-card-img" src="${firstImg}" alt="${esc(p.title)}" onerror="this.parentElement.innerHTML='<div class=no-img>Image unavailable</div>'" />`
            : `<div class="no-img">No image</div>`}
          ${isTop ? `<span style="position:absolute;top:8px;right:8px;background:rgba(255,75,110,0.9);color:#fff;padding:3px 10px;border-radius:10px;font-size:11px;font-weight:700">TOP</span>` : ''}
        </div>
        <div class="post-card-body">
          <div class="post-card-title" title="${esc(p.title)}">${esc(p.title)}</div>
          <div class="post-card-meta">
            <span class="badge badge-cat">${p.category || '-'}</span>
            ${p.is_free ? `<span class="badge" style="background:rgba(52,211,153,0.15);color:var(--green)">FREE</span>` : ''}
            ${dateStr ? `<span class="badge">${dateStr}${endStr}</span>` : ''}
          </div>
          <div style="display:flex;align-items:center;gap:8px;margin-top:8px">
            <label style="font-size:12px;color:var(--text-sub)">Priority:</label>
            <input type="number" value="${p.priority || 0}" min="0" max="99"
              style="width:60px;padding:4px 8px;background:var(--surface2);border:1px solid var(--border);border-radius:4px;color:var(--text);font-size:13px;text-align:center"
              onchange="updateTopPriority('${p.id}', this.value)" />
            ${!isTop ? `<button class="btn btn-sm" style="background:#FF4B6E;color:#fff" onclick="setAsTop('${p.id}')">Top ì¶”ê°€</button>` : ''}
          </div>
        </div>
      </div>`;
  }).join('');
}

async function updateTopPriority(id, value) {
  const priority = parseInt(value) || 0;
  try {
    await callAdmin('update', 'POST', { id, priority });
    toast(`Priority updated to ${priority}`, 'success');
    loadTopSection();
  } catch (e) { toast(e.message, 'error'); }
}

async function setAsTop(id) {
  // Find the next available priority (highest + 1)
  const topItems = topPosts.filter(p => (p.priority || 0) > 0);
  const maxPriority = topItems.length > 0 ? Math.max(...topItems.map(p => p.priority || 0)) : 0;
  const newPriority = maxPriority + 1;

  if (topItems.length >= 5) {
    if (!confirm('ì´ë¯¸ Top 5ê°€ ëª¨ë‘ ì±„ì›Œì ¸ ìˆìŠµë‹ˆë‹¤. ì¶”ê°€í•˜ë©´ 6ê°œ ì´ìƒì´ ë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  }

  try {
    await callAdmin('update', 'POST', { id, priority: newPriority });
    toast(`Topì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤ (Priority: ${newPriority})`, 'success');
    loadTopSection();
  } catch (e) { toast(e.message, 'error'); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INSTAGRAM FEED
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderInstagramPreviews() {
  const input = document.getElementById('igImages');
  const preview = document.getElementById('igPreviewGrid');
  const placeholder = document.getElementById('igUploadPlaceholder');
  const files = Array.from(input.files).slice(0, 5);
  preview.innerHTML = '';
  if (files.length === 0) { placeholder.style.display = ''; return; }
  placeholder.style.display = 'none';
  files.forEach((file, i) => {
    const reader = new FileReader();
    reader.onload = (e) => {
      const item = document.createElement('div');
      item.className = 'preview-item';
      item.innerHTML = `<img src="${e.target.result}" /><button class="remove-btn" onclick="removeInstagramImage(${i})">âœ•</button>`;
      preview.appendChild(item);
    };
    reader.readAsDataURL(file);
  });
}

function removeInstagramImage(index) {
  const input = document.getElementById('igImages');
  const dt = new DataTransfer();
  Array.from(input.files).forEach((file, i) => { if (i !== index) dt.items.add(file); });
  input.files = dt.files;
  renderInstagramPreviews();
}

function getInstagramFormData() {
  const countryCode = document.getElementById('igCountry').value.toUpperCase().trim();
  return {
    instagramUrl: document.getElementById('igUrl').value.trim(),
    title: document.getElementById('igTitle').value.trim(),
    description: document.getElementById('igCaption').value.trim(),
    location: document.getElementById('igLocation').value.trim(),
    price: document.getElementById('igPrice').value.trim(),
    startDate: document.getElementById('igStartDate').value,
    endDate: document.getElementById('igEndDate').value,
    isFree: document.getElementById('igIsFree').checked,
    category: document.getElementById('igCategory').value,
    countryCode,
    language: COUNTRY_LANG_MAP[countryCode] || 'ko',
    imageFiles: Array.from(document.getElementById('igImages').files).slice(0, 5),
  };
}

function resetInstagramForm() {
  ['igUrl','igTitle','igCaption','igLocation','igPrice','igStartDate','igEndDate'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('igIsFree').checked = true;
  document.getElementById('igCategory').value = 'popup';
  document.getElementById('igCountry').value = 'KR';
  document.getElementById('igImages').value = '';
  document.getElementById('igPreviewGrid').innerHTML = '';
  document.getElementById('igUploadPlaceholder').style.display = '';
}

async function saveInstagramDraft() {
  const form = getInstagramFormData();
  if (!form.instagramUrl) { toast('Instagram URL is required', 'error'); return; }
  if (!form.title) { toast('Title is required', 'error'); return; }
  if (form.imageFiles.length === 0) { toast('At least one thumbnail image is required', 'error'); return; }
  showLoading('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘...');
  try {
    const imageUrls = await uploadFeedImages(form.imageFiles);
    const { error } = await sb.from('feed_posts').insert({
      title: form.title, caption: '', overview: form.description || '', source_type: 'instagram',
      images: imageUrls, location_name: form.location || null, price: form.price || null,
      event_start_date: form.startDate || null, event_end_date: form.endDate || null,
      external_link: form.instagramUrl, category: form.category,
      tags: [], is_published: false, publish_date: null, priority: 0,
      is_free: form.isFree, country_code: form.countryCode, language: form.language,
    });
    if (error) throw new Error(error.message);
    toast(`Instagram draft saved: ${form.title}`, 'success');
    resetInstagramForm();
    const draftTab = document.querySelector('.tab[data-status="draft"]');
    if (draftTab) switchTab(draftTab); else loadPosts();
    loadDashboardData();
  } catch (e) { toast(e.message, 'error'); }
  finally { hideLoading(); }
}

async function publishInstagram() {
  const form = getInstagramFormData();
  if (!form.instagramUrl) { toast('Instagram URL is required', 'error'); return; }
  if (!form.title) { toast('Title is required', 'error'); return; }
  if (form.imageFiles.length === 0) { toast('At least one thumbnail image is required', 'error'); return; }
  showLoading('ì´ë¯¸ì§€ ì—…ë¡œë“œ + GPT ìº¡ì…˜ ìƒì„± ì¤‘...');
  try {
    const imageUrls = await uploadFeedImages(form.imageFiles);
    const { data: inserted, error: insertErr } = await sb.from('feed_posts').insert({
      title: form.title, caption: '', overview: form.description || '', source_type: 'instagram',
      images: imageUrls, location_name: form.location || null, price: form.price || null,
      event_start_date: form.startDate || null, event_end_date: form.endDate || null,
      external_link: form.instagramUrl, category: form.category,
      tags: [], is_published: false, publish_date: null, priority: 0,
      is_free: form.isFree, country_code: form.countryCode, language: form.language,
    }).select('id').single();
    if (insertErr) throw new Error(insertErr.message);
    const headers = await getAuthHeaders();
    const res = await fetch(`${EDGE_BASE}/feed-publish-posts`, {
      method: 'POST', headers, body: JSON.stringify({ postIds: [inserted.id] }),
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || 'Publish failed');
    toast(`Instagram published: ${form.title}`, 'success');
    resetInstagramForm(); loadPosts(); loadDashboardData();
  } catch (e) { toast(e.message, 'error'); }
  finally { hideLoading(); }
}

// â”€â”€â”€ Instagram Image Events â”€â”€â”€
document.getElementById('igImages').addEventListener('change', renderInstagramPreviews);
const igDropZone = document.getElementById('igDropZone');
igDropZone.addEventListener('dragover', (e) => { e.preventDefault(); igDropZone.classList.add('dragover'); });
igDropZone.addEventListener('dragleave', () => { igDropZone.classList.remove('dragover'); });
igDropZone.addEventListener('drop', (e) => {
  e.preventDefault(); igDropZone.classList.remove('dragover');
  const input = document.getElementById('igImages');
  const dt = new DataTransfer();
  const existing = Array.from(input.files);
  const dropped = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'));
  [...existing, ...dropped].slice(0, 5).forEach(f => dt.items.add(f));
  input.files = dt.files;
  renderInstagramPreviews();
});

// â”€â”€â”€ Bot Feed (feed_events) â”€â”€â”€
let botFeedData = [];
let botFeedCategory = 'all';

const BOT_CAT_LABELS = {
  popup: 'ğŸ›ï¸ íŒì—…ìŠ¤í† ì–´', market: 'ğŸ›’ í”Œë¦¬ë§ˆì¼“', movie_special: 'ğŸ¬ íŠ¹ë³„ìƒì˜',
  sports: 'ğŸŸï¸ ìŠ¤í¬ì¸ ', concert: 'ğŸµ ê³µì—°', exhibition: 'ğŸ¨ ì „ì‹œ',
  festival: 'ğŸª ì¶•ì œ', musical: 'ğŸ­ ë®¤ì§€ì»¬', tv_audience: 'ğŸ“º TV ë°©ì²­',
};

const BOT_REGION_LABELS = {
  seoul: 'ì„œìš¸', gyeonggi: 'ê²½ê¸°', incheon: 'ì¸ì²œ', daejeon: 'ëŒ€ì „',
  busan: 'ë¶€ì‚°', daegu: 'ëŒ€êµ¬', gwangju: 'ê´‘ì£¼', gangwon: 'ê°•ì›',
  jeju: 'ì œì£¼', jeonbuk: 'ì „ë¶', gyeongbuk: 'ê²½ë¶', gyeongnam: 'ê²½ë‚¨',
  ulsan: 'ìš¸ì‚°', other: 'ê¸°íƒ€',
};

function switchBotFeedTab(el) {
  document.querySelectorAll('#botFeedTabs .tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  botFeedCategory = el.dataset.cat;
  renderBotFeedGrid();
}

async function loadBotFeed() {
  try {
    let query = sb.from('feed_events').select('*').eq('is_active', true).order('start_date', { ascending: true });

    const verifyFilter = document.getElementById('botFeedVerifyFilter')?.value;
    if (verifyFilter === 'unverified') query = query.eq('is_verified', false);
    if (verifyFilter === 'verified') query = query.eq('is_verified', true);

    const regionFilter = document.getElementById('botFeedRegionFilter')?.value;
    if (regionFilter && regionFilter !== 'all') query = query.eq('region', regionFilter);

    const { data, error } = await query;
    if (error) { toast('ë´‡ í”¼ë“œ ë¡œë“œ ì‹¤íŒ¨: ' + error.message, 'error'); return; }
    botFeedData = data || [];
    renderBotFeedStats();
    renderBotFeedGrid();
  } catch (e) { toast(e.message, 'error'); }
}

function renderBotFeedStats() {
  const stats = {};
  let unverified = 0;
  botFeedData.forEach(ev => {
    stats[ev.category] = (stats[ev.category] || 0) + 1;
    if (!ev.is_verified) unverified++;
  });
  const el = document.getElementById('botFeedStats');
  el.innerHTML = `
    <div class="stat-card">
      <div class="stat-card-label">ì „ì²´</div>
      <div class="stat-card-value">${botFeedData.length}</div>
    </div>
    <div class="stat-card">
      <div class="stat-card-label">ë¯¸ê²€ì¦</div>
      <div class="stat-card-value" style="color:var(--orange)">${unverified}</div>
    </div>
    ${Object.entries(stats).map(([cat, cnt]) => `
      <div class="stat-card" style="cursor:pointer" onclick="document.querySelector('#botFeedTabs .tab[data-cat=${cat}]')?.click()">
        <div class="stat-card-label">${BOT_CAT_LABELS[cat] || cat}</div>
        <div class="stat-card-value">${cnt}</div>
      </div>
    `).join('')}
  `;
}

function renderBotFeedGrid() {
  const filtered = botFeedCategory === 'all' ? botFeedData : botFeedData.filter(ev => ev.category === botFeedCategory);
  document.getElementById('botFeedCount').textContent = filtered.length + 'ê±´';

  const el = document.getElementById('botFeedGrid');
  if (filtered.length === 0) {
    el.innerHTML = '<div style="text-align:center;color:var(--text-sub);padding:40px">ë°ì´í„° ì—†ìŒ</div>';
    return;
  }

  el.innerHTML = filtered.map(ev => {
    const catLabel = BOT_CAT_LABELS[ev.category] || ev.category;
    const regionLabel = BOT_REGION_LABELS[ev.region] || ev.region || '-';
    const verifiedBadge = ev.is_verified
      ? '<span class="badge badge-published">ê²€ì¦ë¨</span>'
      : '<span class="badge badge-draft">ë¯¸ê²€ì¦</span>';
    const highlightBadge = ev.is_highlight ? '<span class="badge" style="background:rgba(251,191,36,0.15);color:var(--orange)">ğŸŒŸ í•˜ì´ë¼ì´íŠ¸</span>' : '';
    const tags = (ev.tags || []).map(t => `<span class="badge">${t}</span>`).join('');
    const dateStr = ev.start_date === ev.end_date || !ev.end_date
      ? ev.start_date
      : ev.start_date + ' ~ ' + ev.end_date;
    const timeStr = ev.start_time ? ' ' + ev.start_time : '';
    const priceStr = ev.is_free ? 'ë¬´ë£Œ' : (ev.price_info || '-');

    const allImgs = ev.images && ev.images.length > 0 ? ev.images : (ev.image_url ? [ev.image_url] : []);
    const imgSrc = allImgs[0] || '';
    const imgCount = allImgs.length;

    return `
    <div class="post-card" id="bot-card-${ev.id}">
      ${imgSrc ? `<div style="position:relative;width:100%;height:160px;overflow:hidden;border-radius:var(--radius) var(--radius) 0 0;background:var(--surface2)"><img src="${imgSrc}" style="width:100%;height:100%;object-fit:cover" onerror="this.parentElement.style.display='none'" />${imgCount > 1 ? `<span style="position:absolute;top:8px;right:8px;background:rgba(0,0,0,0.6);color:#fff;font-size:11px;padding:2px 8px;border-radius:10px">ğŸ“· ${imgCount}</span>` : ''}</div>` : ''}
      <div class="post-card-body">
        <div style="display:flex;align-items:center;gap:6px;margin-bottom:8px">
          <span style="font-size:20px">${ev.emoji || 'ğŸª'}</span>
          <span class="badge badge-cat">${catLabel}</span>
          ${verifiedBadge}
          ${highlightBadge}
        </div>
        <div class="post-card-title">${ev.title}</div>
        <div class="post-card-caption">${ev.description || ''}</div>
        <div class="post-card-meta">
          <span class="badge">ğŸ“ ${ev.venue_name || '-'}</span>
          <span class="badge">ğŸ“Œ ${regionLabel}</span>
        </div>
        <div class="post-card-meta">
          <span class="badge">ğŸ“… ${dateStr}${timeStr}</span>
          <span class="badge">ğŸ’° ${priceStr}</span>
          ${tags}
        </div>
        ${ev.source_url ? '<a href="' + ev.source_url + '" target="_blank" style="display:block;padding:8px 12px;background:rgba(59,130,246,0.1);border:1px solid rgba(59,130,246,0.3);border-radius:8px;color:var(--blue);font-size:13px;font-weight:500;margin-bottom:8px;text-decoration:none;word-break:break-all">ğŸ”— ì›ë³¸ ê¸€ ë³´ê¸° â†—<br><span style="font-size:11px;color:var(--text-sub);font-weight:400">' + ev.source_url + '</span></a>' : '<div style="padding:8px 12px;background:rgba(255,200,0,0.1);border:1px solid rgba(255,200,0,0.3);border-radius:8px;color:#e6a700;font-size:12px;margin-bottom:8px">âš ï¸ ì›ë³¸ ë§í¬ ì—†ìŒ â€” ë´‡ ì¬ìˆ˜ì§‘ ì‹œ ìë™ ì¶”ê°€ë©ë‹ˆë‹¤</div>'}
        <div style="font-size:11px;color:var(--text-sub);margin-bottom:10px">
          ì¶œì²˜: ${ev.source} Â· ${ev.created_at ? new Date(ev.created_at).toLocaleDateString('ko') : '-'}
          ${ev.booking_url ? ' Â· <a href="' + ev.booking_url + '" target="_blank" style="color:var(--blue)">ì˜ˆë§¤â†—</a>' : ''}
        </div>
        <div style="margin-bottom:10px">
          <input type="text" id="bot-link-${ev.id}" value="${ev.booking_url || ''}"
            placeholder="ëŒ€í‘œ ë§í¬ (ì˜ˆ: ê³µì‹ í˜ì´ì§€, ì˜ˆë§¤ URL)"
            style="width:100%;padding:8px 10px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:13px;outline:none" />
        </div>
        <div class="post-card-actions">
          ${!ev.is_verified ? `<button class="btn btn-green btn-sm" onclick="verifyBotEvent('${ev.id}')">âœ… ìŠ¹ì¸</button>` : ''}
          <button class="btn btn-outline btn-sm" onclick="openBotEventModal('${ev.id}')">ğŸ“‹ ìƒì„¸/ìˆ˜ì •</button>
          <button class="btn btn-red btn-sm" onclick="deactivateBotEvent('${ev.id}')">ğŸ—‘ ì‚­ì œ</button>
        </div>
      </div>
    </div>`;
  }).join('');
}

// feed_events â†’ feed_posts ì¹´í…Œê³ ë¦¬ ë§¤í•‘
const BOT_TO_FEED_CATEGORY = {
  popup: 'popup', market: 'festival', movie_special: 'show',
  sports: 'sports', concert: 'show', exhibition: 'exhibition',
  festival: 'festival', musical: 'show', tv_audience: 'tv_audience',
};

function botEventToFeedPost(ev) {
  return {
    title: ev.title,
    caption: '',
    source_type: ev.source || 'naver_blog',
    source_id: ev.source_id,
    images: ev.images && ev.images.length > 0 ? ev.images.map(u => u.replace('http://', 'https://')) : (ev.image_url ? [ev.image_url.replace('http://', 'https://')] : []),
    category: BOT_TO_FEED_CATEGORY[ev.category] || ev.category,
    tags: ev.tags || [],
    location_name: ev.venue_name || null,
    latitude: ev.latitude || null,
    longitude: ev.longitude || null,
    region: ev.region || null,
    event_start_date: ev.start_date,
    event_end_date: ev.end_date || ev.start_date,
    start_time: ev.start_time || null,
    price: ev.price_info || null,
    is_free: ev.is_free || false,
    external_link: ev.booking_url || null,
    booking_source: ev.booking_source || null,
    emoji: ev.emoji || 'ğŸª',
    priority: ev.priority || 30,
    is_published: false,
    publish_date: null,
    country_code: 'KR',
    language: 'ko',
    save_count: 0,
    is_highlight: false,
    overview: ev.description || null,
  };
}

async function verifyBotEvent(id) {
  const ev = botFeedData.find(e => e.id === id);
  if (!ev) return;

  // ì…ë ¥ëœ ëŒ€í‘œ ë§í¬ ì½ê¸°
  const linkInput = document.getElementById('bot-link-' + id);
  const linkUrl = linkInput ? linkInput.value.trim() : '';

  showLoading('ìŠ¹ì¸ + GPT ìº¡ì…˜ ìƒì„± ì¤‘...');
  try {
    // 1. feed_events ìŠ¹ì¸ + ë§í¬ ì €ì¥
    const updateData = { is_verified: true };
    if (linkUrl) updateData.booking_url = linkUrl;
    const { error: verifyErr } = await sb.from('feed_events').update(updateData).eq('id', id);
    if (verifyErr) { toast('ìŠ¹ì¸ ì‹¤íŒ¨: ' + verifyErr.message, 'error'); return; }

    // 2. feed_postsì— draftë¡œ ì €ì¥
    if (linkUrl) ev.booking_url = linkUrl;
    const feedPost = botEventToFeedPost(ev);
    const { data: upserted, error: insertErr } = await sb.from('feed_posts').upsert(feedPost, { onConflict: 'source_id' }).select('id').single();
    if (insertErr) { toast('í”¼ë“œ ì €ì¥ ì‹¤íŒ¨: ' + insertErr.message, 'error'); return; }

    // 3. GPT ìº¡ì…˜ ìƒì„± + publish
    const headers = await getAuthHeaders();
    const res = await fetch(`${EDGE_BASE}/feed-publish-posts`, { method: 'POST', headers, body: JSON.stringify({ postIds: [upserted.id] }) });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || 'GPT ìº¡ì…˜ ìƒì„± ì‹¤íŒ¨');

    toast('ìŠ¹ì¸ + GPT ìº¡ì…˜ ìƒì„± + ê²Œì‹œ ì™„ë£Œ', 'success');
    loadBotFeed();
  } catch (e) { toast(e.message, 'error'); }
  finally { hideLoading(); }
}

async function deactivateBotEvent(id) {
  if (!confirm('ì´ ì´ë²¤íŠ¸ë¥¼ ì‚­ì œí•©ë‹ˆê¹Œ? (ë³µêµ¬ ë¶ˆê°€)')) return;
  const ev = botFeedData.find(e => e.id === id);

  // ì‚­ì œ ê¸°ë¡ (ì¬ìˆ˜ì§‘ ë°©ì§€)
  if (ev?.source_id) {
    await sb.from('feed_deleted_sources').upsert({
      source_id: ev.source_id,
      source_type: ev.source_type || null,
      title: ev.title || null,
      event_end_date: ev.event_end_date || ev.end_date || null,
    }, { onConflict: 'source_id' });
    // feed_postsì—ì„œë„ ì‚­ì œ (source_idë¡œ ë§¤ì¹­)
    await sb.from('feed_posts').delete().eq('source_id', ev.source_id);
  }

  // feed_eventsì—ì„œ ì‚­ì œ
  const { error } = await sb.from('feed_events').delete().eq('id', id);
  if (error) { toast('ì‚­ì œ ì‹¤íŒ¨: ' + error.message, 'error'); return; }
  toast('ì‚­ì œ ì™„ë£Œ', 'success');
  loadBotFeed();
}

async function deleteAllBotFeed() {
  if (botFeedData.length === 0) { toast('ì‚­ì œí•  í•­ëª© ì—†ìŒ', 'info'); return; }
  if (!confirm(`ë´‡ í”¼ë“œ ${botFeedData.length}ê±´ì„ ëª¨ë‘ ì‚­ì œí•©ë‹ˆê¹Œ? (ë³µêµ¬ ë¶ˆê°€)`)) return;
  if (!confirm('ì •ë§ ì „ì²´ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) return;

  try {
    const ids = botFeedData.map(ev => ev.id);
    const sourceIds = botFeedData.map(ev => ev.source_id).filter(Boolean);

    // ì‚­ì œ ê¸°ë¡ (ì¬ìˆ˜ì§‘ ë°©ì§€)
    if (sourceIds.length > 0) {
      const deleteRecords = botFeedData.filter(ev => ev.source_id).map(ev => ({
        source_id: ev.source_id,
        source_type: ev.source_type || null,
        title: ev.title || null,
        event_end_date: ev.event_end_date || ev.end_date || null,
      }));
      await sb.from('feed_deleted_sources').upsert(deleteRecords, { onConflict: 'source_id' });
      // feed_postsì—ì„œ ì—°ê²°ëœ ê²Œì‹œë¬¼ ì‚­ì œ
      await sb.from('feed_posts').delete().in('source_id', sourceIds);
    }

    // feed_events ì „ì²´ ì‚­ì œ
    const { error } = await sb.from('feed_events').delete().in('id', ids);
    if (error) { toast('ì „ì²´ ì‚­ì œ ì‹¤íŒ¨: ' + error.message, 'error'); return; }

    toast(`${ids.length}ê±´ ì „ì²´ ì‚­ì œ ì™„ë£Œ`, 'success');
    loadBotFeed();
  } catch (e) { toast('ì „ì²´ ì‚­ì œ ì˜¤ë¥˜: ' + e.message, 'error'); }
}

async function bulkVerifyBotFeed() {
  const unverified = botFeedData.filter(ev => !ev.is_verified);
  if (unverified.length === 0) { toast('ë¯¸ê²€ì¦ í•­ëª© ì—†ìŒ', 'info'); return; }
  if (!confirm(`ë¯¸ê²€ì¦ ${unverified.length}ê±´ì„ ëª¨ë‘ ìŠ¹ì¸ + GPT ìº¡ì…˜ ìƒì„± + í”¼ë“œ ê²Œì‹œí•©ë‹ˆê¹Œ?`)) return;

  showLoading(`${unverified.length}ê±´ ìŠ¹ì¸ + GPT ìº¡ì…˜ ìƒì„± ì¤‘... (ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤)`);
  try {
    // 1. feed_events ì „ì²´ ìŠ¹ì¸
    const evIds = unverified.map(ev => ev.id);
    await sb.from('feed_events').update({ is_verified: true }).in('id', evIds);

    // 2. feed_postsì— draftë¡œ ì €ì¥
    const postIds = [];
    for (const ev of unverified) {
      const feedPost = botEventToFeedPost(ev);
      const { data: upserted, error } = await sb.from('feed_posts').upsert(feedPost, { onConflict: 'source_id' }).select('id').single();
      if (!error && upserted) postIds.push(upserted.id);
    }

    // 3. GPT ìº¡ì…˜ ìƒì„± + publish (í•œë²ˆì—)
    if (postIds.length > 0) {
      const headers = await getAuthHeaders();
      const res = await fetch(`${EDGE_BASE}/feed-publish-posts`, { method: 'POST', headers, body: JSON.stringify({ postIds }) });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'GPT ìº¡ì…˜ ìƒì„± ì‹¤íŒ¨');
      toast(`${data.published || 0}ê±´ ìŠ¹ì¸ + GPT ìº¡ì…˜ ìƒì„± + ê²Œì‹œ ì™„ë£Œ`, 'success');
    } else {
      toast('ì €ì¥ëœ í•­ëª© ì—†ìŒ', 'info');
    }

    loadBotFeed();
  } catch (e) { toast(e.message, 'error'); }
  finally { hideLoading(); }
}

async function runBot3() {
  if (!confirm('ë´‡3 (íŒì—…/í”Œë¦¬ë§ˆì¼“/íŠ¹ë³„ìƒì˜) ìˆ˜ë™ ì‹¤í–‰?')) return;
  const btn = document.getElementById('btnRunBot3');
  if (btn) { btn.disabled = true; btn.innerHTML = '<div class="spinner"></div> ì‹¤í–‰ì¤‘...'; }
  toast('ë´‡3 ì‹¤í–‰ ì¤‘... (1~2ë¶„ ì†Œìš”)', 'info');
  try {
    const { data: { session } } = await sb.auth.getSession();
    const res = await fetch(`${SUPABASE_URL}/functions/v1/batch-collect-trending`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + session.access_token },
    });
    const data = await res.json();
    if (data.success) {
      toast(`ë´‡3 ì™„ë£Œ: ${data.saved}ê±´ ì €ì¥, ${data.skipped}ê±´ ìŠ¤í‚µ`, 'success');
      loadBotFeed();
    } else { toast('ë´‡3 ì‹¤íŒ¨', 'error'); }
  } catch (e) { toast('ë´‡3 ì˜¤ë¥˜: ' + e.message, 'error'); }
  finally { if (btn) { btn.disabled = false; btn.innerHTML = 'ğŸ¤– ë´‡3'; } }
}

async function runBot4() {
  if (!confirm('ë´‡4 (ìŠ¤í¬ì¸ ) ìˆ˜ë™ ì‹¤í–‰?')) return;
  const btn = document.getElementById('btnRunBot4');
  if (btn) { btn.disabled = true; btn.innerHTML = '<div class="spinner"></div> ì‹¤í–‰ì¤‘...'; }
  toast('ë´‡4 ì‹¤í–‰ ì¤‘... (1~2ë¶„ ì†Œìš”)', 'info');
  try {
    const { data: { session } } = await sb.auth.getSession();
    const res = await fetch(`${SUPABASE_URL}/functions/v1/batch-collect-sports`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + session.access_token },
    });
    const data = await res.json();
    if (data.success) {
      toast(`ë´‡4 ì™„ë£Œ: ${data.saved}ê±´ ì €ì¥, ${data.skipped}ê±´ ìŠ¤í‚µ`, 'success');
      loadBotFeed();
    } else { toast('ë´‡4 ì‹¤íŒ¨', 'error'); }
  } catch (e) { toast('ë´‡4 ì˜¤ë¥˜: ' + e.message, 'error'); }
  finally { if (btn) { btn.disabled = false; btn.innerHTML = 'ğŸŸï¸ ë´‡4'; } }
}

function openBotEventModal(id) {
  const ev = botFeedData.find(e => e.id === id);
  if (!ev) return;
  beNewFiles = [];

  const catLabel = BOT_CAT_LABELS[ev.category] || ev.category;
  const regionLabel = BOT_REGION_LABELS[ev.region] || ev.region || '-';
  const dateStr = ev.start_date === ev.end_date || !ev.end_date
    ? ev.start_date || '-'
    : (ev.start_date || '-') + ' ~ ' + (ev.end_date || '-');
  const timeStr = ev.start_time || '-';
  const priceStr = ev.is_free ? 'ë¬´ë£Œ' : (ev.price_info || '-');

  const catOptions = Object.entries(BOT_CAT_LABELS).map(([k,v]) =>
    `<option value="${k}" ${ev.category === k ? 'selected' : ''}>${v}</option>`
  ).join('');
  const regionOptions = Object.entries(BOT_REGION_LABELS).map(([k,v]) =>
    `<option value="${k}" ${ev.region === k ? 'selected' : ''}>${v}</option>`
  ).join('');

  const html = `
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
      <h2 style="margin:0;font-size:18px">ğŸ“‹ ì´ë²¤íŠ¸ ìƒì„¸</h2>
      <button class="btn btn-outline btn-sm" onclick="document.getElementById('botEventModal').classList.remove('show')" style="font-size:18px;padding:4px 10px">âœ•</button>
    </div>

    ${(() => {
      const imgs = ev.images && ev.images.length > 0 ? ev.images : (ev.image_url ? [ev.image_url] : []);
      if (imgs.length === 0) return '';
      return `<div style="display:flex;gap:8px;overflow-x:auto;margin-bottom:16px;padding-bottom:4px">
        ${imgs.map(url => `<img src="${url}" style="width:140px;height:187px;object-fit:cover;border-radius:var(--radius);border:1px solid var(--border);flex-shrink:0" onerror="this.style.display='none'" />`).join('')}
      </div>`;
    })()}

    <div style="display:flex;align-items:center;gap:6px;margin-bottom:12px">
      <span style="font-size:22px">${ev.emoji || 'ğŸª'}</span>
      <span class="badge badge-cat">${catLabel}</span>
      ${ev.is_verified ? '<span class="badge badge-published">ê²€ì¦ë¨</span>' : '<span class="badge badge-draft">ë¯¸ê²€ì¦</span>'}
      ${ev.is_highlight ? '<span class="badge" style="background:rgba(251,191,36,0.15);color:var(--orange)">ğŸŒŸ í•˜ì´ë¼ì´íŠ¸</span>' : ''}
    </div>

    <table style="width:100%;border-collapse:collapse;font-size:14px;margin-bottom:20px">
      <tr style="border-bottom:1px solid var(--border)">
        <td style="padding:10px 12px;color:var(--text-sub);font-weight:500;width:90px;white-space:nowrap">ğŸ“… ì¼ì •</td>
        <td style="padding:10px 12px">${dateStr} ${timeStr !== '-' ? 'Â· ' + timeStr : ''}</td>
      </tr>
      <tr style="border-bottom:1px solid var(--border)">
        <td style="padding:10px 12px;color:var(--text-sub);font-weight:500">ğŸ“ ì¥ì†Œ</td>
        <td style="padding:10px 12px">${ev.venue_name || '-'}${ev.address ? ' Â· ' + ev.address : ''}</td>
      </tr>
      <tr style="border-bottom:1px solid var(--border)">
        <td style="padding:10px 12px;color:var(--text-sub);font-weight:500">ğŸ“Œ ì§€ì—­</td>
        <td style="padding:10px 12px">${regionLabel}</td>
      </tr>
      <tr style="border-bottom:1px solid var(--border)">
        <td style="padding:10px 12px;color:var(--text-sub);font-weight:500">ğŸ’° ê°€ê²©</td>
        <td style="padding:10px 12px">${priceStr}</td>
      </tr>
      <tr style="border-bottom:1px solid var(--border)">
        <td style="padding:10px 12px;color:var(--text-sub);font-weight:500">ğŸ“¡ ì¶œì²˜</td>
        <td style="padding:10px 12px">${ev.source || '-'} ${ev.source_url ? 'Â· <a href="' + ev.source_url + '" target="_blank" style="color:var(--blue)">ì›ë³¸ â†—</a>' : ''}</td>
      </tr>
      ${ev.booking_url ? `<tr style="border-bottom:1px solid var(--border)">
        <td style="padding:10px 12px;color:var(--text-sub);font-weight:500">ğŸ« ì˜ˆë§¤</td>
        <td style="padding:10px 12px"><a href="${ev.booking_url}" target="_blank" style="color:var(--blue);word-break:break-all">${ev.booking_url}</a></td>
      </tr>` : ''}
      ${(ev.tags || []).length > 0 ? `<tr style="border-bottom:1px solid var(--border)">
        <td style="padding:10px 12px;color:var(--text-sub);font-weight:500">ğŸ·ï¸ íƒœê·¸</td>
        <td style="padding:10px 12px">${ev.tags.map(t => '<span class="badge">' + t + '</span>').join(' ')}</td>
      </tr>` : ''}
    </table>

    ${ev.description ? `<div style="padding:12px;background:var(--surface2);border-radius:var(--radius);margin-bottom:20px;font-size:14px;line-height:1.6;color:var(--text-sub)">${ev.description}</div>` : ''}

    <div style="border-top:1px solid var(--border);padding-top:20px;margin-bottom:8px">
      <h3 style="font-size:15px;margin:0 0 14px 0">âœï¸ ì •ë³´ ìˆ˜ì •</h3>
    </div>

    <div class="form-group">
      <label>ì œëª©</label>
      <input type="text" id="beTitle" value="${(ev.title || '').replace(/"/g, '&quot;')}" />
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
      <div class="form-group">
        <label>ì¹´í…Œê³ ë¦¬</label>
        <select id="beCategory">${catOptions}</select>
      </div>
      <div class="form-group">
        <label>ì§€ì—­</label>
        <select id="beRegion">${regionOptions}</select>
      </div>
    </div>
    <div class="form-group">
      <label>ì¥ì†Œ</label>
      <input type="text" id="beVenue" value="${(ev.venue_name || '').replace(/"/g, '&quot;')}" />
    </div>
    <div class="form-group">
      <label>ì„¤ëª…</label>
      <textarea id="beDesc" rows="3">${ev.description || ''}</textarea>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
      <div class="form-group">
        <label>ì‹œì‘ì¼</label>
        <input type="date" id="beStartDate" value="${ev.start_date || ''}" />
      </div>
      <div class="form-group">
        <label>ì¢…ë£Œì¼</label>
        <input type="date" id="beEndDate" value="${ev.end_date || ''}" />
      </div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
      <div class="form-group">
        <label>ì‹œê°„</label>
        <input type="text" id="beTime" value="${ev.start_time || ''}" placeholder="ì˜ˆ: 19:00" />
      </div>
      <div class="form-group">
        <label>ê°€ê²© ì •ë³´</label>
        <input type="text" id="bePrice" value="${(ev.price_info || '').replace(/"/g, '&quot;')}" placeholder="ë¬´ë£Œ / 10,000ì› ë“±" />
      </div>
    </div>
    <div class="form-group">
      <label>ì´ë¯¸ì§€ (ì—¬ëŸ¬ ì¥ ê°€ëŠ¥)</label>
      <div id="beImagesGrid" style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:8px">
        ${(() => {
          const imgs = ev.images && ev.images.length > 0 ? ev.images : (ev.image_url ? [ev.image_url] : []);
          return imgs.map((url, idx) => `
            <div class="be-img-item" data-url="${url}" style="position:relative;width:120px;height:160px;flex-shrink:0">
              <img src="${url}" style="width:100%;height:100%;object-fit:cover;border-radius:var(--radius);border:1px solid var(--border)" onerror="this.parentElement.style.display='none'" />
              <button type="button" onclick="removeBotEventImage(this)" style="position:absolute;top:4px;right:4px;background:rgba(0,0,0,0.6);color:#fff;border:none;border-radius:50%;width:24px;height:24px;cursor:pointer;font-size:12px;display:flex;align-items:center;justify-content:center">âœ•</button>
              <span style="position:absolute;bottom:4px;left:4px;background:rgba(0,0,0,0.6);color:#fff;font-size:10px;padding:2px 6px;border-radius:10px">${idx + 1}</span>
            </div>`).join('');
        })()}
      </div>
      <input type="file" id="beImageFiles" accept="image/*" multiple style="display:none" onchange="addBotEventImages(this)" />
      <button type="button" class="btn btn-outline btn-sm" onclick="document.getElementById('beImageFiles').click()" style="width:100%">ğŸ“· ì´ë¯¸ì§€ ì¶”ê°€</button>
    </div>
    <div class="form-group">
      <label>ì˜ˆë§¤/ë§í¬ URL</label>
      <input type="url" id="beBooking" value="${ev.booking_url || ''}" />
    </div>
    <div class="form-group">
      <label>íƒœê·¸ (ì‰¼í‘œ êµ¬ë¶„)</label>
      <input type="text" id="beTags" value="${(ev.tags || []).join(', ')}" />
    </div>
    <div style="display:flex;gap:8px;align-items:center;margin-bottom:4px">
      <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
        <input type="checkbox" id="beIsFree" ${ev.is_free ? 'checked' : ''} style="accent-color:var(--accent);width:18px;height:18px" />
        ë¬´ë£Œ ì´ë²¤íŠ¸
      </label>
      <label style="display:flex;align-items:center;gap:8px;cursor:pointer;margin-left:16px">
        <input type="checkbox" id="beHighlight" ${ev.is_highlight ? 'checked' : ''} style="accent-color:var(--orange);width:18px;height:18px" />
        ğŸŒŸ í•˜ì´ë¼ì´íŠ¸
      </label>
    </div>

    <div class="modal-footer">
      <button class="btn btn-outline" onclick="document.getElementById('botEventModal').classList.remove('show')">ë‹«ê¸°</button>
      <button class="btn btn-primary" onclick="saveBotEventEdit('${ev.id}')">ğŸ’¾ ì €ì¥</button>
    </div>
  `;

  document.getElementById('botEventModalContent').innerHTML = html;
  document.getElementById('botEventModal').classList.add('show');
}

// --- Multi-image management for bot event modal ---
let beNewFiles = []; // staged File objects to upload on save

function addBotEventImages(input) {
  const grid = document.getElementById('beImagesGrid');
  for (const file of input.files) {
    const reader = new FileReader();
    reader.onload = (e) => {
      const idx = grid.querySelectorAll('.be-img-item').length;
      const div = document.createElement('div');
      div.className = 'be-img-item';
      div.dataset.newFileIdx = String(beNewFiles.length);
      div.style.cssText = 'position:relative;width:120px;height:160px;flex-shrink:0';
      div.innerHTML = `
        <img src="${e.target.result}" style="width:100%;height:100%;object-fit:cover;border-radius:var(--radius);border:1px solid var(--border)" />
        <button type="button" onclick="removeBotEventImage(this)" style="position:absolute;top:4px;right:4px;background:rgba(0,0,0,0.6);color:#fff;border:none;border-radius:50%;width:24px;height:24px;cursor:pointer;font-size:12px;display:flex;align-items:center;justify-content:center">âœ•</button>
        <span style="position:absolute;bottom:4px;left:4px;background:rgba(0,0,0,0.6);color:#fff;font-size:10px;padding:2px 6px;border-radius:10px">NEW</span>`;
      grid.appendChild(div);
      beNewFiles.push(file);
      reindexBotEventImages();
    };
    reader.readAsDataURL(file);
  }
  input.value = '';
}

function removeBotEventImage(btn) {
  const item = btn.closest('.be-img-item');
  if (item.dataset.newFileIdx !== undefined && item.dataset.newFileIdx !== '') {
    beNewFiles[parseInt(item.dataset.newFileIdx)] = null;
  }
  item.remove();
  reindexBotEventImages();
}

function reindexBotEventImages() {
  const items = document.querySelectorAll('#beImagesGrid .be-img-item');
  items.forEach((item, i) => {
    const badge = item.querySelector('span');
    if (badge) badge.textContent = item.dataset.newFileIdx !== undefined && item.dataset.newFileIdx !== '' ? 'NEW' : String(i + 1);
  });
}

function collectBotEventImageState() {
  const items = document.querySelectorAll('#beImagesGrid .be-img-item');
  const existingUrls = [];
  const newFileIndices = [];
  items.forEach(item => {
    if (item.dataset.url) {
      existingUrls.push(item.dataset.url);
    } else if (item.dataset.newFileIdx !== undefined && item.dataset.newFileIdx !== '') {
      const idx = parseInt(item.dataset.newFileIdx);
      if (beNewFiles[idx]) newFileIndices.push(idx);
    }
  });
  return { existingUrls, newFileIndices };
}

async function uploadBotEventImage(file) {
  const ext = file.name.split('.').pop().toLowerCase();
  const fileName = `${Date.now()}_${Math.random().toString(36).slice(2, 8)}.${ext}`;
  const path = `bot-events/${fileName}`;
  const { error } = await sb.storage.from('feed-images').upload(path, file, { contentType: file.type, upsert: false });
  if (error) throw new Error('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨: ' + error.message);
  const { data: urlData } = sb.storage.from('feed-images').getPublicUrl(path);
  return urlData.publicUrl;
}

async function saveBotEventEdit(id) {
  const ev = botFeedData.find(e => e.id === id);
  if (!ev) return;

  const updates = {};
  const title = document.getElementById('beTitle').value.trim();
  const category = document.getElementById('beCategory').value;
  const region = document.getElementById('beRegion').value;
  const venue = document.getElementById('beVenue').value.trim();
  const desc = document.getElementById('beDesc').value.trim();
  const startDate = document.getElementById('beStartDate').value;
  const endDate = document.getElementById('beEndDate').value;
  const time = document.getElementById('beTime').value.trim();
  const price = document.getElementById('bePrice').value.trim();
  const booking = document.getElementById('beBooking').value.trim();
  const tagsStr = document.getElementById('beTags').value.trim();
  const isFree = document.getElementById('beIsFree').checked;
  const isHighlight = document.getElementById('beHighlight').checked;

  // Handle multi-image upload
  const { existingUrls, newFileIndices } = collectBotEventImageState();
  const finalImages = [...existingUrls];

  if (newFileIndices.length > 0) {
    try {
      showLoading(`ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘... (0/${newFileIndices.length})`);
      for (let i = 0; i < newFileIndices.length; i++) {
        showLoading(`ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘... (${i + 1}/${newFileIndices.length})`);
        const url = await uploadBotEventImage(beNewFiles[newFileIndices[i]]);
        finalImages.push(url);
      }
    } catch (e) {
      hideLoading();
      toast(e.message, 'error');
      return;
    } finally {
      hideLoading();
    }
  }

  const oldImages = ev.images && ev.images.length > 0 ? ev.images : (ev.image_url ? [ev.image_url] : []);
  if (JSON.stringify(finalImages) !== JSON.stringify(oldImages)) {
    updates.images = finalImages;
    updates.image_url = finalImages.length > 0 ? finalImages[0] : null;
  }

  if (title && title !== ev.title) updates.title = title;
  if (category !== ev.category) updates.category = category;
  if (region !== ev.region) updates.region = region;
  if (venue !== (ev.venue_name || '')) updates.venue_name = venue || null;
  if (desc !== (ev.description || '')) updates.description = desc || null;
  if (startDate !== (ev.start_date || '')) updates.start_date = startDate || null;
  if (endDate !== (ev.end_date || '')) updates.end_date = endDate || null;
  if (time !== (ev.start_time || '')) updates.start_time = time || null;
  if (price !== (ev.price_info || '')) updates.price_info = price || null;
  if (booking !== (ev.booking_url || '')) updates.booking_url = booking || null;
  if (isFree !== ev.is_free) updates.is_free = isFree;
  if (isHighlight !== !!ev.is_highlight) updates.is_highlight = isHighlight;

  const newTags = tagsStr ? tagsStr.split(',').map(t => t.trim()).filter(Boolean) : [];
  const oldTags = (ev.tags || []).join(',');
  if (newTags.join(',') !== oldTags) updates.tags = newTags;

  if (Object.keys(updates).length === 0) { toast('ë³€ê²½ ì—†ìŒ', 'info'); return; }

  updates.updated_at = new Date().toISOString();
  const { error } = await sb.from('feed_events').update(updates).eq('id', id);
  if (error) { toast('ìˆ˜ì • ì‹¤íŒ¨: ' + error.message, 'error'); return; }

  toast('ìˆ˜ì • ì™„ë£Œ', 'success');
  document.getElementById('botEventModal').classList.remove('show');
  loadBotFeed();
}

// â”€â”€â”€ Init â”€â”€â”€
checkSession();
</script>
</body>
</html>
