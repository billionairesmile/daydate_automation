<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Daydate Feed Admin</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <style>
    :root {
      --bg: #0f0f0f;
      --surface: #1a1a1a;
      --surface2: #242424;
      --border: #333;
      --text: #e8e8e8;
      --text-sub: #888;
      --accent: #7c5cfc;
      --accent-hover: #6a4aec;
      --green: #34d399;
      --red: #f87171;
      --orange: #fbbf24;
      --radius: 10px;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    /* ─── Login ─── */
    .login-wrap {
      display: flex; align-items: center; justify-content: center;
      min-height: 100vh; padding: 20px;
    }
    .login-box {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: var(--radius); padding: 40px; width: 100%; max-width: 400px;
    }
    .login-box h1 { font-size: 24px; margin-bottom: 8px; }
    .login-box p { color: var(--text-sub); margin-bottom: 24px; font-size: 14px; }
    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; font-size: 13px; color: var(--text-sub); margin-bottom: 6px; }
    .form-group input, .form-group textarea, .form-group select {
      width: 100%; padding: 10px 12px; background: var(--surface2);
      border: 1px solid var(--border); border-radius: 8px;
      color: var(--text); font-size: 14px; outline: none;
    }
    .form-group input:focus, .form-group textarea:focus {
      border-color: var(--accent);
    }
    .btn {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 10px 18px; border: none; border-radius: 8px;
      font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.15s;
    }
    .btn-primary { background: var(--accent); color: #fff; }
    .btn-primary:hover { background: var(--accent-hover); }
    .btn-green { background: var(--green); color: #000; }
    .btn-red { background: var(--red); color: #000; }
    .btn-orange { background: var(--orange); color: #000; }
    .btn-outline {
      background: transparent; border: 1px solid var(--border); color: var(--text);
    }
    .btn-outline:hover { border-color: var(--text-sub); }
    .btn-sm { padding: 6px 12px; font-size: 12px; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-full { width: 100%; justify-content: center; }
    .error-msg { color: var(--red); font-size: 13px; margin-top: 8px; }

    /* ─── Layout ─── */
    .app { display: none; }
    .header {
      background: var(--surface); border-bottom: 1px solid var(--border);
      padding: 16px 24px; display: flex; align-items: center; justify-content: space-between;
      position: sticky; top: 0; z-index: 100;
    }
    .header h1 { font-size: 18px; }
    .header-right { display: flex; align-items: center; gap: 12px; }
    .user-email { font-size: 13px; color: var(--text-sub); }

    .container { max-width: 1200px; margin: 0 auto; padding: 24px; }

    /* ─── Tabs ─── */
    .tabs { display: flex; gap: 4px; margin-bottom: 20px; }
    .tab {
      padding: 10px 20px; border-radius: 8px; cursor: pointer;
      font-size: 14px; background: transparent; border: 1px solid var(--border);
      color: var(--text-sub); transition: all 0.15s;
    }
    .tab.active { background: var(--accent); border-color: var(--accent); color: #fff; }

    /* ─── Toolbar ─── */
    .toolbar {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 16px; flex-wrap: wrap; gap: 12px;
    }
    .toolbar-left { display: flex; gap: 8px; align-items: center; }
    .toolbar-right { display: flex; gap: 8px; }
    .count-badge {
      font-size: 13px; color: var(--text-sub);
      padding: 6px 12px; background: var(--surface2); border-radius: 20px;
    }

    /* ─── Cards ─── */
    .post-grid {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
      gap: 16px;
    }
    .post-card {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: var(--radius); overflow: hidden; transition: border-color 0.15s;
    }
    .post-card:hover { border-color: var(--text-sub); }
    .post-card-img {
      width: 100%; height: 180px; object-fit: cover; background: var(--surface2);
    }
    .post-card-body { padding: 16px; }
    .post-card-title {
      font-size: 15px; font-weight: 600; margin-bottom: 6px;
      overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }
    .post-card-caption {
      font-size: 13px; color: var(--text-sub); margin-bottom: 10px;
      display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
      overflow: hidden; line-height: 1.5;
    }
    .post-card-meta {
      display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px;
    }
    .badge {
      font-size: 11px; padding: 3px 8px; border-radius: 4px;
      background: var(--surface2); color: var(--text-sub);
    }
    .badge-published { background: rgba(52,211,153,0.15); color: var(--green); }
    .badge-draft { background: rgba(251,191,36,0.15); color: var(--orange); }
    .badge-cat { background: rgba(124,92,252,0.15); color: var(--accent); }
    .post-card-actions { display: flex; gap: 6px; flex-wrap: wrap; }
    .post-card-checkbox {
      position: absolute; top: 12px; left: 12px; width: 20px; height: 20px;
      accent-color: var(--accent);
    }
    .post-card-img-wrap { position: relative; }
    .no-img {
      width: 100%; height: 180px; display: flex; align-items: center;
      justify-content: center; background: var(--surface2); color: var(--text-sub);
      font-size: 13px;
    }

    /* ─── Modal ─── */
    .modal-overlay {
      display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7);
      z-index: 200; align-items: center; justify-content: center; padding: 20px;
    }
    .modal-overlay.show { display: flex; }
    .modal {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: var(--radius); max-width: 640px; width: 100%;
      max-height: 85vh; overflow-y: auto; padding: 28px;
    }
    .modal h2 { font-size: 18px; margin-bottom: 20px; }
    .modal-footer { display: flex; gap: 8px; justify-content: flex-end; margin-top: 24px; }

    /* ─── Action Panel ─── */
    .action-panel {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: var(--radius); padding: 20px; margin-bottom: 24px;
    }
    .action-panel h3 { font-size: 15px; margin-bottom: 14px; }
    .action-row { display: flex; gap: 12px; align-items: flex-end; flex-wrap: wrap; }
    .action-row .form-group { flex: 1; min-width: 200px; margin-bottom: 0; }

    /* ─── Toast ─── */
    .toast-container {
      position: fixed; top: 20px; right: 20px; z-index: 999;
      display: flex; flex-direction: column; gap: 8px;
    }
    .toast {
      padding: 12px 20px; border-radius: 8px; font-size: 14px;
      animation: slideIn 0.2s ease; min-width: 250px;
    }
    .toast-success { background: var(--green); color: #000; }
    .toast-error { background: var(--red); color: #000; }
    .toast-info { background: var(--accent); color: #fff; }
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    /* ─── Spinner ─── */
    .spinner {
      display: inline-block; width: 16px; height: 16px;
      border: 2px solid rgba(255,255,255,0.3); border-top-color: #fff;
      border-radius: 50%; animation: spin 0.6s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .loading-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.5);
      display: flex; align-items: center; justify-content: center;
      z-index: 300; display: none;
    }
    .loading-overlay.show { display: flex; }
    .loading-box {
      background: var(--surface); padding: 24px 32px; border-radius: var(--radius);
      display: flex; align-items: center; gap: 12px; font-size: 14px;
    }

    @media (max-width: 768px) {
      .container { padding: 16px; }
      .post-grid { grid-template-columns: 1fr; }
      .action-row { flex-direction: column; }
      .action-row .form-group { min-width: 100%; }
    }
  </style>
</head>
<body>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-box">
    <div class="spinner"></div>
    <span id="loadingText">Processing...</span>
  </div>
</div>

<!-- ─── Login Screen ─── -->
<div class="login-wrap" id="loginScreen">
  <div class="login-box">
    <h1>Daydate Admin</h1>
    <p>Feed 관리 페이지에 로그인하세요</p>
    <div class="form-group">
      <label>Email</label>
      <input type="email" id="loginEmail" placeholder="admin@example.com" />
    </div>
    <div class="form-group">
      <label>Password</label>
      <input type="password" id="loginPassword" placeholder="********" />
    </div>
    <div id="loginError" class="error-msg" style="display:none"></div>
    <button class="btn btn-primary btn-full" style="margin-top:16px" onclick="handleLogin()">
      Login
    </button>
  </div>
</div>

<!-- ─── App ─── -->
<div class="app" id="appScreen">
  <!-- Header -->
  <div class="header">
    <h1>Daydate Feed Admin</h1>
    <div class="header-right">
      <span class="user-email" id="userEmail"></span>
      <button class="btn btn-outline btn-sm" onclick="handleLogout()">Logout</button>
    </div>
  </div>

  <div class="container">
    <!-- Action Panels -->
    <div class="action-panel">
      <h3>KOPIS Sync (공연/전시 자동 수집)</h3>
      <p style="font-size:13px;color:var(--text-sub);margin-bottom:12px">
        KOPIS API에서 현재~30일 내 공연/축제를 자동 수집합니다. (공연DB: 대중음악, 대중무용 / 축제DB: 대중음악, 대중무용)
      </p>
      <button class="btn btn-primary" id="btnSyncKopis" onclick="syncKopis()">
        Sync Now
      </button>
    </div>

    <div class="action-panel">
      <h3>Manual Curation (수동 큐레이션)</h3>
      <div class="action-row" style="flex-wrap:wrap">
        <div class="form-group" style="flex:1;min-width:200px">
          <label>Images (최대 5장)</label>
          <input type="file" id="curateImages" accept="image/jpeg,image/png,image/webp" multiple
            style="padding:8px;cursor:pointer" />
          <div id="imagePreview" style="display:flex;gap:6px;margin-top:8px;flex-wrap:wrap"></div>
        </div>
        <div class="form-group" style="flex:1;min-width:200px">
          <label>Caption Text (내용 입력) *</label>
          <textarea id="curateCaption" rows="3" placeholder="장소명, 특징, 날짜, 가격 등 자유롭게 입력...&#10;예: 여의도 벚꽃축제 4/5~4/13, 무료, 한강 야경 포토스팟"></textarea>
        </div>
        <div class="form-group" style="flex:0.4;min-width:130px">
          <label>Category (optional)</label>
          <select id="curateCategory">
            <option value="">GPT 자동 분류</option>
            <option value="festival">festival</option>
            <option value="performance">performance</option>
            <option value="restaurant">restaurant</option>
            <option value="activity">activity</option>
            <option value="spot">spot</option>
          </select>
        </div>
        <div class="form-group" style="flex:0.5;min-width:150px">
          <label>Instagram URL (optional)</label>
          <input type="url" id="curateUrl" placeholder="https://www.instagram.com/p/..." />
        </div>
        <div class="form-group" style="flex:0.5;min-width:150px">
          <label>Notes (운영자 메모)</label>
          <input type="text" id="curateNotes" placeholder="추가 메모" />
        </div>
        <button class="btn btn-primary" style="height:40px;align-self:flex-end" onclick="curatePost()">Curate</button>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <div class="tab active" data-status="all" onclick="switchTab(this)">All</div>
      <div class="tab" data-status="published" onclick="switchTab(this)">Published</div>
      <div class="tab" data-status="draft" onclick="switchTab(this)">Draft</div>
    </div>

    <!-- Toolbar -->
    <div class="toolbar">
      <div class="toolbar-left">
        <span class="count-badge" id="postCount">0 posts</span>
        <label style="font-size:13px;display:flex;align-items:center;gap:6px;color:var(--text-sub);cursor:pointer">
          <input type="checkbox" id="selectAll" onchange="toggleSelectAll()" style="accent-color:var(--accent)" />
          Select All
        </label>
      </div>
      <div class="toolbar-right">
        <button class="btn btn-green btn-sm" id="btnBulkPublish" onclick="bulkPublish()" style="display:none">
          Publish Selected
        </button>
        <button class="btn btn-outline btn-sm" onclick="loadPosts()">Refresh</button>
      </div>
    </div>

    <!-- Post Grid -->
    <div class="post-grid" id="postGrid"></div>
  </div>
</div>

<!-- ─── Edit Modal ─── -->
<div class="modal-overlay" id="editModal">
  <div class="modal">
    <h2>Edit Post</h2>
    <input type="hidden" id="editId" />
    <div class="form-group">
      <label>Title</label>
      <input type="text" id="editTitle" />
    </div>
    <div class="form-group">
      <label>Caption</label>
      <textarea id="editCaption" rows="4"></textarea>
    </div>
    <div class="form-group">
      <label>Category</label>
      <select id="editCategory">
        <option value="performance">performance</option>
        <option value="festival">festival</option>
        <option value="restaurant">restaurant</option>
        <option value="activity">activity</option>
        <option value="spot">spot</option>
      </select>
    </div>
    <div class="form-group">
      <label>Location</label>
      <input type="text" id="editLocation" />
    </div>
    <div class="form-group">
      <label>Price</label>
      <input type="text" id="editPrice" />
    </div>
    <div class="form-group">
      <label>External Link</label>
      <input type="url" id="editLink" />
    </div>
    <div class="form-group">
      <label>Tags (comma separated)</label>
      <input type="text" id="editTags" />
    </div>
    <div class="form-group">
      <label>Images (JSON array of URLs)</label>
      <textarea id="editImages" rows="3" style="font-family:monospace;font-size:12px"></textarea>
    </div>
    <div class="form-group">
      <label>Priority (higher = more visible)</label>
      <input type="number" id="editPriority" value="0" />
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeEditModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveEdit()">Save</button>
    </div>
  </div>
</div>

<!-- ─── Detail Modal ─── -->
<div class="modal-overlay" id="detailModal">
  <div class="modal" style="max-width:720px">
    <div id="detailContent"></div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeDetailModal()">Close</button>
    </div>
  </div>
</div>

<script>
// ─── Config ───
const SUPABASE_URL = 'https://olhdwsfhbghpeatzgurp.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9saGR3c2ZoYmdocGVhdHpndXJwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2NzMwODcsImV4cCI6MjA4MDI0OTA4N30.Zt4H3OeZtIg7YfEOEwIyNN89XucV9iuyBQ7mOtLuBq8';
const EDGE_BASE = `${SUPABASE_URL}/functions/v1`;

const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let currentTab = 'all';
let posts = [];
let selectedIds = new Set();

// ─── Auth ───
async function checkSession() {
  const { data: { session } } = await sb.auth.getSession();
  if (session) {
    showApp(session.user);
  }
}

async function handleLogin() {
  const email = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPassword').value;
  const errEl = document.getElementById('loginError');
  errEl.style.display = 'none';

  if (!email || !password) {
    errEl.textContent = 'Email and password are required';
    errEl.style.display = 'block';
    return;
  }

  const { data, error } = await sb.auth.signInWithPassword({ email, password });
  if (error) {
    errEl.textContent = error.message;
    errEl.style.display = 'block';
    return;
  }
  showApp(data.user);
}

async function handleLogout() {
  await sb.auth.signOut();
  document.getElementById('appScreen').style.display = 'none';
  document.getElementById('loginScreen').style.display = 'flex';
}

function showApp(user) {
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('appScreen').style.display = 'block';
  document.getElementById('userEmail').textContent = user.email;
  loadPosts();
}

// ─── API helpers ───
async function getAuthHeaders() {
  const { data: { session } } = await sb.auth.getSession();
  if (!session) {
    toast('Session expired. Please re-login.', 'error');
    handleLogout();
    throw new Error('No session');
  }
  return {
    'Authorization': `Bearer ${session.access_token}`,
    'Content-Type': 'application/json',
  };
}

async function callAdmin(action, method = 'GET', body = null) {
  const headers = await getAuthHeaders();
  const opts = { method, headers };
  let url = `${EDGE_BASE}/feed-admin?action=${action}`;

  if (method === 'GET' && body) {
    for (const [k, v] of Object.entries(body)) {
      url += `&${k}=${encodeURIComponent(v)}`;
    }
  }
  if (method === 'POST' && body) {
    opts.body = JSON.stringify(body);
  }

  const res = await fetch(url, opts);
  const data = await res.json();
  if (!res.ok) throw new Error(data.error || 'Request failed');
  return data;
}

// ─── Load Posts ───
async function loadPosts() {
  try {
    const params = { status: currentTab, limit: '100', offset: '0' };
    const result = await callAdmin('list', 'GET', params);
    posts = result.data || [];
    renderPosts();
  } catch (e) {
    toast(e.message, 'error');
  }
}

// ─── Render ───
function renderPosts() {
  const grid = document.getElementById('postGrid');
  document.getElementById('postCount').textContent = `${posts.length} posts`;
  selectedIds.clear();
  updateBulkBtn();
  document.getElementById('selectAll').checked = false;

  if (posts.length === 0) {
    grid.innerHTML = '<p style="color:var(--text-sub);text-align:center;padding:40px;grid-column:1/-1">No posts found</p>';
    return;
  }

  grid.innerHTML = posts.map(p => {
    const images = p.images || [];
    const firstImg = images[0];
    const isPublished = p.is_published;
    const tags = (p.tags || []).slice(0, 3);
    const dateStr = p.event_start_date ? formatDate(p.event_start_date) : '';
    const endStr = p.event_end_date ? ` ~ ${formatDate(p.event_end_date)}` : '';

    return `
      <div class="post-card" data-id="${p.id}">
        <div class="post-card-img-wrap">
          <input type="checkbox" class="post-card-checkbox" value="${p.id}"
            ${selectedIds.has(p.id) ? 'checked' : ''}
            onchange="toggleSelect('${p.id}', this.checked)" />
          ${firstImg
            ? `<img class="post-card-img" src="${firstImg}" alt="${esc(p.title)}" onerror="this.parentElement.innerHTML='<div class=no-img>Image unavailable</div>'" />`
            : `<div class="no-img">No image</div>`}
        </div>
        <div class="post-card-body">
          <div class="post-card-title" title="${esc(p.title)}">${esc(p.title)}</div>
          <div class="post-card-caption">${esc(p.caption || '')}</div>
          <div class="post-card-meta">
            <span class="badge ${isPublished ? 'badge-published' : 'badge-draft'}">
              ${isPublished ? 'Published' : 'Draft'}
            </span>
            <span class="badge badge-cat">${p.category || '-'}</span>
            ${p.source_type ? `<span class="badge">${p.source_type}</span>` : ''}
            ${dateStr ? `<span class="badge">${dateStr}${endStr}</span>` : ''}
            ${images.length > 1 ? `<span class="badge">${images.length} imgs</span>` : ''}
          </div>
          ${tags.length ? `<div style="margin-bottom:10px">${tags.map(t => `<span style="font-size:11px;color:var(--accent);margin-right:6px">#${esc(t)}</span>`).join('')}</div>` : ''}
          <div class="post-card-actions">
            <button class="btn btn-outline btn-sm" onclick="viewDetail('${p.id}')">View</button>
            <button class="btn btn-outline btn-sm" onclick="openEditModal('${p.id}')">Edit</button>
            ${isPublished
              ? `<button class="btn btn-orange btn-sm" onclick="unpublishPost('${p.id}')">Unpublish</button>`
              : `<button class="btn btn-green btn-sm" onclick="publishPost('${p.id}')">Publish</button>`}
            <button class="btn btn-red btn-sm" onclick="deletePost('${p.id}')">Delete</button>
          </div>
        </div>
      </div>`;
  }).join('');
}

function formatDate(dateStr) {
  if (!dateStr) return '';
  const d = new Date(dateStr);
  return `${d.getMonth() + 1}/${d.getDate()}`;
}

function esc(str) {
  if (!str) return '';
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ─── Tabs ───
function switchTab(el) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  currentTab = el.dataset.status;
  loadPosts();
}

// ─── Selection ───
function toggleSelect(id, checked) {
  if (checked) selectedIds.add(id);
  else selectedIds.delete(id);
  updateBulkBtn();
}

function toggleSelectAll() {
  const checked = document.getElementById('selectAll').checked;
  document.querySelectorAll('.post-card-checkbox').forEach(cb => {
    cb.checked = checked;
    if (checked) selectedIds.add(cb.value);
    else selectedIds.delete(cb.value);
  });
  updateBulkBtn();
}

function updateBulkBtn() {
  const btn = document.getElementById('btnBulkPublish');
  btn.style.display = selectedIds.size > 0 ? 'inline-flex' : 'none';
  btn.textContent = `Publish Selected (${selectedIds.size})`;
}

// ─── Actions ───
async function publishPost(id) {
  try {
    await callAdmin('publish', 'POST', { id });
    toast('Published!', 'success');
    loadPosts();
  } catch (e) { toast(e.message, 'error'); }
}

async function unpublishPost(id) {
  try {
    await callAdmin('unpublish', 'POST', { id });
    toast('Unpublished', 'success');
    loadPosts();
  } catch (e) { toast(e.message, 'error'); }
}

async function deletePost(id) {
  if (!confirm('Are you sure you want to delete this post?')) return;
  try {
    await callAdmin('delete', 'POST', { id });
    toast('Deleted', 'success');
    loadPosts();
  } catch (e) { toast(e.message, 'error'); }
}

async function bulkPublish() {
  if (selectedIds.size === 0) return;
  if (!confirm(`Publish ${selectedIds.size} posts?`)) return;
  try {
    await callAdmin('bulk_publish', 'POST', { ids: [...selectedIds] });
    toast(`Published ${selectedIds.size} posts`, 'success');
    selectedIds.clear();
    loadPosts();
  } catch (e) { toast(e.message, 'error'); }
}

// ─── Detail ───
function viewDetail(id) {
  const p = posts.find(x => x.id === id);
  if (!p) return;
  const images = p.images || [];
  const attrs = p.image_attributions || [];
  const tags = p.tags || [];

  document.getElementById('detailContent').innerHTML = `
    <h2 style="margin-bottom:16px">${esc(p.title)}</h2>
    ${images.length ? `
      <div style="display:flex;gap:8px;overflow-x:auto;margin-bottom:16px">
        ${images.map((img, i) => `
          <img src="${img}" style="height:200px;border-radius:8px;object-fit:cover"
            onerror="this.style.display='none'" />
        `).join('')}
      </div>` : ''}
    <p style="color:var(--text-sub);line-height:1.6;margin-bottom:16px">${esc(p.caption)}</p>
    <table style="width:100%;font-size:13px;border-collapse:collapse">
      ${detailRow('ID', p.id)}
      ${detailRow('Category', p.category)}
      ${detailRow('Source', p.source_type + (p.source_id ? ` (${p.source_id})` : ''))}
      ${detailRow('Status', p.is_published ? 'Published' : 'Draft')}
      ${detailRow('Location', p.location_name)}
      ${detailRow('Price', p.price)}
      ${detailRow('Event', p.event_start_date ? `${p.event_start_date} ~ ${p.event_end_date || ''}` : '-')}
      ${detailRow('External Link', p.external_link ? `<a href="${p.external_link}" target="_blank" style="color:var(--accent)">${p.external_link}</a>` : '-')}
      ${detailRow('Tags', tags.map(t => `#${esc(t)}`).join(' '))}
      ${detailRow('Priority', p.priority)}
      ${detailRow('Save Count', p.save_count)}
      ${detailRow('Created', new Date(p.created_at).toLocaleString('ko-KR'))}
      ${detailRow('Updated', new Date(p.updated_at).toLocaleString('ko-KR'))}
    </table>
    ${attrs.length ? `
      <div style="margin-top:16px">
        <strong style="font-size:13px">Image Attributions:</strong>
        ${attrs.map(a => `<div style="font-size:12px;color:var(--text-sub);margin-top:4px">Photo by <a href="${a.photographerUrl}" target="_blank" style="color:var(--accent)">${esc(a.photographerName)}</a> on <a href="${a.photoUrl}" target="_blank" style="color:var(--accent)">Unsplash</a></div>`).join('')}
      </div>` : ''}
  `;
  document.getElementById('detailModal').classList.add('show');
}

function detailRow(label, value) {
  return `<tr><td style="padding:6px 8px;color:var(--text-sub);border-bottom:1px solid var(--border);white-space:nowrap;vertical-align:top">${label}</td><td style="padding:6px 8px;border-bottom:1px solid var(--border);word-break:break-all">${value || '-'}</td></tr>`;
}

function closeDetailModal() {
  document.getElementById('detailModal').classList.remove('show');
}

// ─── Edit ───
function openEditModal(id) {
  const p = posts.find(x => x.id === id);
  if (!p) return;
  document.getElementById('editId').value = p.id;
  document.getElementById('editTitle').value = p.title || '';
  document.getElementById('editCaption').value = p.caption || '';
  document.getElementById('editCategory').value = p.category || 'spot';
  document.getElementById('editLocation').value = p.location_name || '';
  document.getElementById('editPrice').value = p.price || '';
  document.getElementById('editLink').value = p.external_link || '';
  document.getElementById('editTags').value = (p.tags || []).join(', ');
  document.getElementById('editImages').value = JSON.stringify(p.images || [], null, 2);
  document.getElementById('editPriority').value = p.priority || 0;
  document.getElementById('editModal').classList.add('show');
}

function closeEditModal() {
  document.getElementById('editModal').classList.remove('show');
}

async function saveEdit() {
  const id = document.getElementById('editId').value;
  let images;
  try {
    images = JSON.parse(document.getElementById('editImages').value);
  } catch {
    toast('Invalid images JSON', 'error');
    return;
  }
  const tags = document.getElementById('editTags').value
    .split(',').map(t => t.trim()).filter(Boolean);

  const updates = {
    id,
    title: document.getElementById('editTitle').value,
    caption: document.getElementById('editCaption').value,
    category: document.getElementById('editCategory').value,
    location_name: document.getElementById('editLocation').value,
    price: document.getElementById('editPrice').value,
    external_link: document.getElementById('editLink').value,
    tags,
    images,
    priority: parseInt(document.getElementById('editPriority').value) || 0,
  };

  try {
    await callAdmin('update', 'POST', updates);
    toast('Saved!', 'success');
    closeEditModal();
    loadPosts();
  } catch (e) { toast(e.message, 'error'); }
}

// ─── KOPIS Sync ───
async function syncKopis() {
  const btn = document.getElementById('btnSyncKopis');
  btn.disabled = true;
  btn.innerHTML = '<div class="spinner"></div> Syncing...';
  showLoading('KOPIS API 동기화 중... (최대 1분 소요)');

  try {
    const headers = await getAuthHeaders();
    const res = await fetch(`${EDGE_BASE}/feed-sync-kopis`, {
      method: 'POST',
      headers,
      body: JSON.stringify({}),
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || 'Sync failed');

    toast(
      `Sync complete: ${data.inserted || 0} inserted, ${data.skippedDuplicates || 0} duplicates, ${data.errors || 0} errors`,
      data.inserted > 0 ? 'success' : 'info'
    );
    loadPosts();
  } catch (e) {
    toast(e.message, 'error');
  } finally {
    btn.disabled = false;
    btn.innerHTML = 'Sync Now';
    hideLoading();
  }
}

// ─── Image Preview ───
document.getElementById('curateImages').addEventListener('change', function() {
  const preview = document.getElementById('imagePreview');
  preview.innerHTML = '';
  const files = Array.from(this.files).slice(0, 5);
  files.forEach((file, i) => {
    const reader = new FileReader();
    reader.onload = (e) => {
      const wrap = document.createElement('div');
      wrap.style.cssText = 'position:relative;width:60px;height:60px;border-radius:6px;overflow:hidden';
      wrap.innerHTML = `<img src="${e.target.result}" style="width:100%;height:100%;object-fit:cover"/>
        <span style="position:absolute;top:2px;right:4px;color:#fff;font-size:10px;text-shadow:0 0 3px #000">${i+1}</span>`;
      preview.appendChild(wrap);
    };
    reader.readAsDataURL(file);
  });
});

// ─── Upload images to Supabase Storage ───
async function uploadFeedImages(files) {
  const urls = [];
  for (const file of files) {
    const ext = file.name.split('.').pop().toLowerCase();
    const fileName = `${Date.now()}_${Math.random().toString(36).slice(2, 8)}.${ext}`;
    const path = `curated/${fileName}`;

    const { data, error } = await sb.storage
      .from('feed-images')
      .upload(path, file, { contentType: file.type, upsert: false });

    if (error) {
      console.error('Upload error:', error);
      throw new Error(`Image upload failed: ${error.message}`);
    }

    const { data: urlData } = sb.storage.from('feed-images').getPublicUrl(path);
    urls.push(urlData.publicUrl);
  }
  return urls;
}

// ─── Manual Curation ───
async function curatePost() {
  const url = document.getElementById('curateUrl').value.trim();
  const caption = document.getElementById('curateCaption').value.trim();
  const notes = document.getElementById('curateNotes').value.trim();
  const category = document.getElementById('curateCategory').value;
  const imageInput = document.getElementById('curateImages');
  const imageFiles = Array.from(imageInput.files).slice(0, 5);

  if (!caption) {
    toast('Caption text is required', 'error');
    return;
  }

  showLoading(imageFiles.length > 0 ? '이미지 업로드 + GPT 처리 중...' : 'GPT + Unsplash 처리 중...');
  try {
    // Upload images first if provided
    let imageUrls = [];
    if (imageFiles.length > 0) {
      imageUrls = await uploadFeedImages(imageFiles);
    }

    const headers = await getAuthHeaders();
    const body = { caption_text: caption };
    if (url) body.instagram_url = url;
    if (notes) body.manual_notes = notes;
    if (category) body.category = category;
    if (imageUrls.length > 0) body.image_urls = imageUrls;

    const res = await fetch(`${EDGE_BASE}/feed-curate-instagram`, {
      method: 'POST',
      headers,
      body: JSON.stringify(body),
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.detail ? `${data.error}: ${data.detail}` : data.error || 'Curation failed');

    toast(`Draft created: ${data.post?.title || 'New post'}`, 'success');
    document.getElementById('curateUrl').value = '';
    document.getElementById('curateCaption').value = '';
    document.getElementById('curateNotes').value = '';
    document.getElementById('curateCategory').value = '';
    imageInput.value = '';
    document.getElementById('imagePreview').innerHTML = '';

    // Switch to draft tab to see the new post
    const draftTab = document.querySelector('.tab[data-status="draft"]');
    if (draftTab) switchTab(draftTab);
    else loadPosts();
  } catch (e) {
    toast(e.message, 'error');
  } finally {
    hideLoading();
  }
}

// ─── Toast ───
function toast(msg, type = 'info') {
  const container = document.getElementById('toastContainer');
  const el = document.createElement('div');
  el.className = `toast toast-${type}`;
  el.textContent = msg;
  container.appendChild(el);
  setTimeout(() => el.remove(), 4000);
}

// ─── Loading ───
function showLoading(text) {
  document.getElementById('loadingText').textContent = text || 'Processing...';
  document.getElementById('loadingOverlay').classList.add('show');
}
function hideLoading() {
  document.getElementById('loadingOverlay').classList.remove('show');
}

// ─── Close modals on overlay click ───
document.querySelectorAll('.modal-overlay').forEach(overlay => {
  overlay.addEventListener('click', (e) => {
    if (e.target === overlay) {
      overlay.classList.remove('show');
    }
  });
});

// ─── Keyboard shortcuts ───
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    document.querySelectorAll('.modal-overlay.show').forEach(m => m.classList.remove('show'));
  }
});

// ─── Init ───
checkSession();
</script>
</body>
</html>
